<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGrow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #27ae60; text-align: center; }
        .status { background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
        button { padding: 12px; border: none; border-radius: 5px; background: #3498db; color: white; font-size: 16px; cursor: pointer; }
        button:hover { background: #2980b9; }
        button.on { background: #27ae60; }
        button.off { background: #e74c3c; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .data { background: #e3f2fd; padding: 15px; border-radius: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå± EcoGrow Test Panel</h1>
        
        <div class="controls">
            <button onclick="sendCommand('pump_on')" class="on">üö∞ –ù–∞—Å–æ—Å –í–ö–õ</button>
            <button onclick="sendCommand('pump_off')" class="off">üö∞ –ù–∞—Å–æ—Å –í–´–ö–õ</button>
            <button onclick="sendCommand('light_on')" class="on">üí° –°–≤–µ—Ç –í–ö–õ</button>
            <button onclick="sendCommand('light_off')" class="off">üí° –°–≤–µ—Ç –í–´–ö–õ</button>
            <button onclick="sendCommand('pump_auto')">üîÑ –ê–≤—Ç–æ –ø–æ–ª–∏–≤</button>
            <button onclick="sendCommand('light_auto')">üîÑ –ê–≤—Ç–æ —Å–≤–µ—Ç</button>
        </div>
        
        <div style="margin: 20px 0;">
            <label>–ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏: <span id="thresholdValue">50</span>%</label>
            <input type="range" id="thresholdSlider" min="10" max="90" value="50" style="width: 100%;">
            <button onclick="updateThreshold()" style="width: 100%; margin-top: 10px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ä–æ–≥</button>
        </div>
        
        <div class="status">
            <h3>üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</h3>
            <div id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <div class="data">
            <h3>üì° –î–∞–Ω–Ω—ã–µ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</h3>
            <pre id="jsonData">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</pre>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="loadData()" style="background: #9b59b6;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–¥—Ä–µ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: 
                <input type="text" id="deviceAddress" value="http://ecogrow.local" style="width: 200px;">
            </div>
        </div>
    </div>

    <script>
        let deviceAddress = "http://ecogrow.local";
        
        document.getElementById('deviceAddress').addEventListener('change', function(e) {
            deviceAddress = e.target.value;
            if (!deviceAddress.startsWith('http://')) {
                deviceAddress = 'http://' + deviceAddress;
            }
            loadData();
        });
        
        document.getElementById('thresholdSlider').addEventListener('input', function(e) {
            document.getElementById('thresholdValue').textContent = e.target.value;
        });
        
        async function loadData() {
            try {
                const response = await fetch(deviceAddress + '/api/state');
                const data = await response.json();
                
                document.getElementById('statusText').innerHTML = `
                    üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: <strong>${data.moisture}%</strong><br>
                    üö∞ –ù–∞—Å–æ—Å: <strong>${data.pump ? '–í–ö–õ' : '–í–´–ö–õ'}</strong><br>
                    üí° –°–≤–µ—Ç: <strong>${data.light ? '–í–ö–õ' : '–í–´–ö–õ'}</strong><br>
                    üéØ –ü–æ—Ä–æ–≥: <strong>${data.threshold}%</strong>
                `;
                
                document.getElementById('jsonData').textContent = JSON.stringify(data, null, 2);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä
                document.getElementById('thresholdSlider').value = data.threshold;
                document.getElementById('thresholdValue').textContent = data.threshold;
                
            } catch (error) {
                document.getElementById('statusText').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                document.getElementById('jsonData').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
                
                // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∞–¥—Ä–µ—Å–∞
                const altAddresses = [
                    'http://192.168.1.100',
                    'http://192.168.0.100'
                ];
                
                for (let addr of altAddresses) {
                    try {
                        const test = await fetch(addr + '/api/state');
                        if (test.ok) {
                            deviceAddress = addr;
                            document.getElementById('deviceAddress').value = deviceAddress;
                            loadData();
                            return;
                        }
                    } catch(e) {}
                }
            }
        }
        
        async function sendCommand(cmd) {
            try {
                const response = await fetch(deviceAddress + '/api/command', {
                    method: 'POST',
                    body: cmd,
                    headers: {
                        'Content-Type': 'text/plain'
                    }
                });
                
                if (response.ok) {
                    alert('–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ' + cmd);
                    setTimeout(loadData, 1000);
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        function updateThreshold() {
            const value = document.getElementById('thresholdSlider').value;
            sendCommand('threshold=' + value);
        }
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(loadData, 5000);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = loadData;
    </script>
</body>
</html>
