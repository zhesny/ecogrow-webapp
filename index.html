<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± EcoGrow Control</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .connection-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .devices-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .device-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .device-card:hover {
            transform: translateY(-5px);
        }
        
        .device-card.online {
            border-left: 5px solid #27ae60;
        }
        
        .device-card.offline {
            border-left: 5px solid #e74c3c;
            opacity: 0.7;
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f2f6;
        }
        
        .device-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .device-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .status-online {
            background: rgba(39, 174, 96, 0.15);
            color: #27ae60;
        }
        
        .status-offline {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }
        
        .device-info {
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f1f2f6;
        }
        
        .info-label {
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .moisture-value {
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            color: #3498db;
            margin: 10px 0;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        
        .btn-secondary {
            background: #f1f2f6;
            color: #2c3e50;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .settings-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .setting-item {
            margin-bottom: 20px;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #f1f2f6;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            border-left: 5px solid #27ae60;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            border-left-color: #e74c3c;
        }
        
        @media (max-width: 768px) {
            .devices-list {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± EcoGrow Remote Control</h1>
            <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –∞–≤—Ç–æ–ø–æ–ª–∏–≤–∞ –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –º–∏—Ä–∞</p>
            <p id="firebaseStatus" style="margin-top: 10px;">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</p>
        </div>
        
        <div class="connection-panel">
            <h2>üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
            <p id="devicesCount">–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤...</p>
            <div id="devicesList" class="devices-list">
                <!-- –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
        
        <div id="selectedDevicePanel" style="display: none;">
            <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <div class="chart-container">
            <h2>üìà –ì—Ä–∞—Ñ–∏–∫ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏</h2>
            <canvas id="moistureChart"></canvas>
        </div>
        
        <div class="settings-panel">
            <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="setting-item">
                <label class="setting-label">–ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏: <span id="thresholdValue">50%</span></label>
                <div class="slider-container">
                    <input type="range" id="moistureThreshold" min="10" max="90" step="1" value="50">
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞ (—Å–µ–∫—É–Ω–¥—ã):</label>
                <input type="number" id="wateringDuration" min="1" max="300" value="10" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #f1f2f6;">
            </div>
            <button class="btn btn-success" onclick="saveSettings()" style="margin-top: 15px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–Æ!)
        const firebaseConfig = {
            apiKey: "–í–ê–®_API_KEY",
            authDomain: "–í–ê–®_–ü–†–û–ï–ö–¢.firebaseapp.com",
            databaseURL: "https://–í–ê–®_–ü–†–û–ï–ö–¢.firebaseio.com",
            projectId: "–í–ê–®_–ü–†–û–ï–ö–¢",
            storageBucket: "–í–ê–®_–ü–†–û–ï–ö–¢.appspot.com",
            messagingSenderId: "–í–ê–®_SENDER_ID",
            appId: "–í–ê–®_APP_ID"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        let currentDevice = null;
        let moistureChart = null;
        let moistureHistory = [];
        
        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        auth.signInAnonymously()
            .then(() => {
                console.log("Firebase: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∞–Ω–æ–Ω–∏–º–Ω–æ");
                document.getElementById('firebaseStatus').innerHTML = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase";
                loadDevices();
            })
            .catch(error => {
                console.error("Firebase auth error:", error);
                document.getElementById('firebaseStatus').innerHTML = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase";
            });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function loadDevices() {
            const devicesRef = database.ref('devices');
            
            devicesRef.on('value', (snapshot) => {
                const devices = snapshot.val();
                const devicesList = document.getElementById('devicesList');
                const devicesCount = document.getElementById('devicesCount');
                
                if (!devices) {
                    devicesList.innerHTML = '<div class="device-card"><p>–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p></div>';
                    devicesCount.textContent = "–ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: 0";
                    return;
                }
                
                let html = '';
                let count = 0;
                
                for (const deviceId in devices) {
                    const device = devices[deviceId];
                    const isOnline = (Date.now() / 1000 - (device.data?.timestamp || 0)) < 120; // 2 –º–∏–Ω—É—Ç—ã
                    
                    count++;
                    html += `
                        <div class="device-card ${isOnline ? 'online' : 'offline'}" onclick="selectDevice('${deviceId}')" style="cursor: pointer;">
                            <div class="device-header">
                                <div class="device-name">${device.name || '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ' + deviceId}</div>
                                <div class="device-status ${isOnline ? 'status-online' : 'status-offline'}">
                                    ${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ—Ñ–ª–∞–π–Ω'}
                                </div>
                            </div>
                            <div class="device-info">
                                <div class="info-row">
                                    <span class="info-label">IP –∞–¥—Ä–µ—Å:</span>
                                    <span class="info-value">${device.ip || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å:</span>
                                    <span class="info-value">${device.data?.moisture || '--'}%</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ù–∞—Å–æ—Å:</span>
                                    <span class="info-value">${device.data?.pump ? 'üü¢ –í–ö–õ' : 'üî¥ –í–´–ö–õ'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–°–≤–µ—Ç:</span>
                                    <span class="info-value">${device.data?.light ? 'üü¢ –í–ö–õ' : 'üî¥ –í–´–ö–õ'}</span>
                                </div>
                            </div>
                            ${isOnline ? `
                                <div class="moisture-value">
                                    ${device.data?.moisture || '--'}%
                                </div>
                                <div class="controls">
                                    <button class="btn ${device.data?.pump ? 'btn-danger' : 'btn-success'}" 
                                            onclick="event.stopPropagation(); togglePump('${deviceId}', ${!device.data?.pump})">
                                        ${device.data?.pump ? '‚õî –í—ã–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å' : 'üíß –í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å'}
                                    </button>
                                    <button class="btn ${device.data?.light ? 'btn-danger' : 'btn-success'}" 
                                            onclick="event.stopPropagation(); toggleLight('${deviceId}', ${!device.data?.light})">
                                        ${device.data?.light ? 'üí° –í—ã–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç' : 'üí° –í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                devicesList.innerHTML = html;
                devicesCount.textContent = `–ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${count}`;
                
                // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ –æ–Ω–ª–∞–π–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                if (!currentDevice && count > 0) {
                    for (const deviceId in devices) {
                        const device = devices[deviceId];
                        const isOnline = (Date.now() / 1000 - (device.data?.timestamp || 0)) < 120;
                        if (isOnline) {
                            selectDevice(deviceId);
                            break;
                        }
                    }
                }
            });
        }
        
        // –í—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function selectDevice(deviceId) {
            currentDevice = deviceId;
            const deviceRef = database.ref('devices/' + deviceId);
            
            deviceRef.on('value', (snapshot) => {
                const device = snapshot.val();
                if (!device) return;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ø–∞–Ω–µ–ª–∏
                updateDevicePanel(device);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                if (device.data?.moisture) {
                    moistureHistory.push(device.data.moisture);
                    if (moistureHistory.length > 50) moistureHistory.shift();
                    updateChart();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                if (device.settings) {
                    document.getElementById('moistureThreshold').value = device.settings.moistureThreshold || 50;
                    document.getElementById('thresholdValue').textContent = (device.settings.moistureThreshold || 50) + '%';
                    document.getElementById('wateringDuration').value = device.settings.wateringDurationSec || 10;
                }
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('selectedDevicePanel').innerHTML = `
                <div class="connection-panel">
                    <h2>üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º: ${deviceId}</h2>
                    <div id="deviceDetails">
                        <!-- –î–µ—Ç–∞–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                    </div>
                </div>
            `;
            document.getElementById('selectedDevicePanel').style.display = 'block';
            
            showNotification(`‚úÖ –í—ã–±—Ä–∞–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${deviceId}`);
        }
        
        function updateDevicePanel(device) {
            const panel = document.getElementById('deviceDetails');
            if (!panel) return;
            
            const isOnline = (Date.now() / 1000 - (device.data?.timestamp || 0)) < 120;
            
            panel.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
                        <div style="font-size: 3rem; font-weight: 800; text-align: center; color: #3498db;">
                            ${device.data?.moisture || '--'}%
                        </div>
                        <p style="text-align: center; color: #7f8c8d;">–í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">üö∞ –ù–∞—Å–æ—Å</h3>
                        <div style="font-size: 2.5rem; text-align: center; margin: 15px 0;">
                            ${device.data?.pump ? 'üíß –í–ö–õ–Æ–ß–ï–ù' : '‚õî –í–´–ö–õ–Æ–ß–ï–ù'}
                        </div>
                        <button class="btn ${device.data?.pump ? 'btn-danger' : 'btn-success'}" 
                                onclick="togglePump('${currentDevice}', ${!device.data?.pump})" 
                                style="width: 100%;">
                            ${device.data?.pump ? '‚õî –í—ã–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å' : 'üíß –í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å'}
                        </button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">üí° –§–∏—Ç–æ–ª–∞–º–ø–∞</h3>
                        <div style="font-size: 2.5rem; text-align: center; margin: 15px 0;">
                            ${device.data?.light ? 'üîÜ –í–ö–õ–Æ–ß–ï–ù–ê' : 'üåô –í–´–ö–õ–Æ–ß–ï–ù–ê'}
                        </div>
                        <button class="btn ${device.data?.light ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleLight('${currentDevice}', ${!device.data?.light})" 
                                style="width: 100%;">
                            ${device.data?.light ? 'üí° –í—ã–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç' : 'üí° –í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–º
        function togglePump(deviceId, state) {
            sendCommand(deviceId, 'pump', state ? 1 : 0);
            showNotification(state ? 'üíß –ù–∞—Å–æ—Å –≤–∫–ª—é—á–µ–Ω' : '‚õî –ù–∞—Å–æ—Å –≤—ã–∫–ª—é—á–µ–Ω');
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–æ–º
        function toggleLight(deviceId, state) {
            sendCommand(deviceId, 'light', state ? 1 : 0);
            showNotification(state ? 'üí° –°–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω' : 'üåô –°–≤–µ—Ç –≤—ã–∫–ª—é—á–µ–Ω');
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        function sendCommand(deviceId, command, value) {
            database.ref('devices/' + deviceId + '/commands/latest').set({
                command: command,
                value: value,
                timestamp: Date.now(),
                source: 'web'
            });
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function saveSettings() {
            if (!currentDevice) {
                showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', true);
                return;
            }
            
            const threshold = document.getElementById('moistureThreshold').value;
            const duration = document.getElementById('wateringDuration').value;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
            sendCommand(currentDevice, 'threshold', parseInt(threshold));
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Firebase
            database.ref('devices/' + currentDevice + '/settings').update({
                moistureThreshold: parseInt(threshold),
                wateringDurationSec: parseInt(duration),
                lastUpdated: Date.now()
            });
            
            showNotification('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        function initChart() {
            const ctx = document.getElementById('moistureChart').getContext('2d');
            moistureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã (%)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: { display: false }
                    }
                }
            });
        }
        
        function updateChart() {
            if (!moistureChart) initChart();
            
            moistureChart.data.datasets[0].data = moistureHistory;
            moistureChart.data.labels = [];
            for (let i = 0; i < moistureHistory.length; i++) {
                moistureChart.data.labels.push('');
            }
            moistureChart.update('none');
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            initChart();
            showNotification('üåê –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤...');
        };
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (currentDevice) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å
                const deviceRef = database.ref('devices/' + currentDevice + '/data/timestamp');
                deviceRef.get().then(snapshot => {
                    const timestamp = snapshot.val();
                    const isOnline = (Date.now() / 1000 - timestamp) < 120;
                    
                    if (!isOnline) {
                        showNotification('‚ö†Ô∏è –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≤ —Å–µ—Ç–∏', true);
                    }
                });
            }
        }, 5000);
    </script>
</body>
</html>
