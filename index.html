<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGrow Assistant</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' https://cdn.jsdelivr.net https://www.gstatic.com https://cdnjs.cloudflare.com 'unsafe-inline'; 
                   style-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; 
                   font-src 'self' https://cdnjs.cloudflare.com; 
                   img-src 'self' data:; 
                   connect-src 'self' https://ecogrow-remote-default-rtdb.firebaseio.com">
    
    <!-- Иконки -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* СТИЛИ БЕЗ ИЗМЕНЕНИЙ - ВСТАВЬТЕ ВСЁ ИЗ ПРЕДЫДУЩЕГО КОДА */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            min-height: 100vh;
            transition: background 0.3s ease;
        }
        /* ... остальные стили без изменений ... */
    </style>
</head>
<body>
    <!-- Preloader -->
    <div id="preloader">
        <div class="preloader-content">
            <div class="preloader-spinner">
                <i class="fas fa-seedling"></i>
            </div>
            <div>Загрузка EcoGrow Assistant...</div>
            <div style="margin-top: 10px; font-size: 0.9rem; color: #94a3b8;" id="preloaderStatus">Инициализация системы</div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-seedling"></i>
                    <h1>EcoGrow Assistant</h1>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Подключение...</span>
                    <span id="lastUpdate" style="margin-left: 15px; font-size: 0.9rem; color: #94a3b8;">--:--:--</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Top Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-tint"></i>
                </div>
                <h3>Влажность почвы</h3>
                <div class="stat-value" id="moistureValue">--%</div>
                <div class="stat-trend" id="moistureTrend">↗ Загрузка...</div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-icon">
                    <i class="fas fa-sun"></i>
                </div>
                <h3>Свет</h3>
                <div class="stat-value" id="lightStatus">ВЫКЛ</div>
                <div class="stat-trend" id="lightTimer">--:--</div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="fas fa-water"></i>
                </div>
                <h3>Насос</h3>
                <div class="stat-value" id="pumpStatus">ВЫКЛ</div>
                <div class="stat-trend" id="pumpTimer">--:--</div>
            </div>
        </div>

        <div class="main-layout">
            <!-- Left Column: Chart & Controls -->
            <div>
                <!-- Chart -->
                <div class="section">
                    <h2><i class="fas fa-chart-line"></i> График влажности</h2>
                    <div class="chart-wrapper">
                        <canvas id="moistureChart"></canvas>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.9rem; color: #94a3b8;">Средняя</div>
                            <div class="stat-value" style="font-size: 1.5rem;" id="avgMoisture">--%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.9rem; color: #94a3b8;">Минимум</div>
                            <div class="stat-value" style="font-size: 1.5rem;" id="minMoisture">--%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.9rem; color: #94a3b8;">Максимум</div>
                            <div class="stat-value" style="font-size: 1.5rem;" id="maxMoisture">--%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.9rem; color: #94a3b8;">Тренд</div>
                            <div class="stat-value" style="font-size: 1.5rem;" id="trendValue">→</div>
                        </div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="section">
                    <h2><i class="fas fa-sliders-h"></i> Управление системой</h2>
                    <div class="controls-grid">
                        <div class="control-group">
                            <h3><i class="fas fa-cogs"></i> Автополив</h3>
                            <div style="margin-bottom: 20px;">
                                <label for="autoWateringToggle" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="autoWateringToggle" checked style="width: 20px; height: 20px;">
                                    <span>Автополив включен</span>
                                </label>
                            </div>
                            
                            <div class="slider-container">
                                <label for="moistureThreshold" style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.95rem;">Порог влажности:</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="moistureThreshold" min="10" max="90" value="50" class="slider">
                                    <span class="slider-value" id="thresholdValue">50%</span>
                                </div>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <label for="pumpDuration" style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.95rem;">Длительность полива (сек):</label>
                                <input type="number" id="pumpDuration" min="1" max="300" value="10" style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 2px solid #334155; border-radius: 8px; color: white; margin-top: 8px;">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <h3><i class="fas fa-hand-paper"></i> Ручное управление</h3>
                            <div class="manual-controls">
                                <button class="control-btn" id="manualPumpBtn">
                                    <i class="fas fa-water"></i>
                                    <span id="pumpBtnText">Включить насос</span>
                                </button>
                                <button class="control-btn warning" id="manualLightBtn">
                                    <i class="fas fa-lightbulb"></i>
                                    <span id="lightBtnText">Включить свет</span>
                                </button>
                                
                                <div style="margin-top: 15px;">
                                    <div style="margin-bottom: 8px; color: #94a3b8; font-size: 0.95rem;">Быстрый полив:</div>
                                    <div class="quick-water-buttons">
                                        <button class="quick-water-btn" id="quickWater5">5с</button>
                                        <button class="quick-water-btn" id="quickWater10">10с</button>
                                        <button class="quick-water-btn" id="quickWater30">30с</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Status & Info -->
            <div>
                <!-- System Status -->
                <div class="section">
                    <h2><i class="fas fa-heartbeat"></i> Статус системы</h2>
                    <div id="statusContainer">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div>Загрузка статуса...</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <h3><i class="fas fa-clock"></i> Системное время</h3>
                        <div class="current-time" id="currentTime">--:--:--</div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="control-btn" id="syncTimeBtn" style="background: linear-gradient(135deg, #475569 0%, #334155 100%); padding: 12px 24px;">
                                <i class="fas fa-sync-alt"></i> Синхронизировать время
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Error History -->
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;"><i class="fas fa-exclamation-triangle"></i> История ошибок</h2>
                        <button id="clearErrorsBtn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 2px solid rgba(239, 68, 68, 0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                            <i class="fas fa-trash"></i> Очистить
                        </button>
                    </div>
                    
                    <div id="errorList">
                        <div class="no-data">
                            <i class="fas fa-check-circle"></i>
                            <p>Ошибок не обнаружено</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer container">
        <p>EcoGrow Assistant v4.5 | Разработано Купченя Евгением</p>
        <p style="margin-top: 5px; font-size: 0.9rem;">Система автоматического полива растений</p>
        <p style="margin-top: 10px; font-size: 0.8rem; color: #64748b;">Время сервера: <span id="serverTime">--:--:--</span> | Аптайм: <span id="uptime">--</span></p>
    </footer>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Main App -->
    <script>
        // Инициализация Firebase (версия 8)
        const firebaseConfig = {
            apiKey: "AIzaSyBsZr7vWJDFt_S5i0Rvj6ejp6QT0JX9SPk",
            authDomain: "ecogrow-remote.firebaseapp.com",
            databaseURL: "https://ecogrow-remote-default-rtdb.firebaseio.com",
            projectId: "ecogrow-remote",
            storageBucket: "ecogrow-remote.firebasestorage.app",
            messagingSenderId: "121689275158",
            appId: "1:121689275158:web:f3b1829755c8b8a1fb2e37",
            measurementId: "G-PG5116NH38"
        };
        
        // Инициализация Firebase
        try {
            if (firebase && firebase.initializeApp) {
                firebase.initializeApp(firebaseConfig);
                window.firebaseDatabase = firebase.database();
                console.log('✅ Firebase инициализирован');
            } else {
                console.warn('⚠️ Firebase SDK не загружен');
                window.firebaseDatabase = null;
            }
        } catch (error) {
            console.error('❌ Ошибка Firebase:', error);
            window.firebaseDatabase = null;
        }
    </script>
    
    <!-- Application -->
    <script src="app.js"></script>
</body>
</html>
