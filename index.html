<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± EcoGrow Control Panel</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #2c3e50;
            --accent-green: #27ae60;
            --accent-blue: #3498db;
            --accent-red: #e74c3c;
            --border-color: #e1e8ed;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #ecf0f1;
            --border-color: #2c3e50;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        .header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .status-on { background: rgba(39, 174, 96, 0.15); color: var(--accent-green); }
        .status-off { background: rgba(52, 152, 219, 0.15); color: var(--accent-blue); }
        
        .control-group { margin: 15px 0; }
        
        .control-item {
            margin-bottom: 15px;
        }
        
        .control-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border-color);
            outline: none;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        
        .btn-success {
            background: var(--accent-green);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 5px;
        }
        
        .chart-container {
            height: 200px;
            margin: 20px 0;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            border-left: 4px solid var(--accent-green);
            transform: translateY(100px);
            transition: transform 0.3s;
        }
        
        .notification.show {
            transform: translateY(0);
        }
        
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .btn-group { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="app-title">
                <span class="material-icons">eco</span>
                EcoGrow Control
            </h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram</p>
            <div id="connection_status" class="status-badge status-off">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">water_drop</span>
                    –í–ª–∞–∂–Ω–æ—Å—Ç—å
                </div>
                <div id="moist_status" class="status-badge">--%</div>
            </div>
            
            <div class="chart-container">
                <canvas id="moist_chart"></canvas>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div id="current_moist" class="stat-value">--%</div>
                    <div>–¢–µ–∫—É—â–∞—è</div>
                </div>
                <div class="stat-card">
                    <div id="avg_moist" class="stat-value">--%</div>
                    <div>–°—Ä–µ–¥–Ω—è—è</div>
                </div>
            </div>
            
            <div class="control-item">
                <label>–ü–æ—Ä–æ–≥ –ø–æ–ª–∏–≤–∞: <span id="thresh_val">50%</span></label>
                <input id="moist_threshold" type="range" min="10" max="90" step="1" value="50">
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">water_drop</span>
                    –ù–∞—Å–æ—Å
                </div>
                <div id="pump_status" class="status-badge status-off">–í–´–ö–õ</div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" onclick="sendCommand('pump', 'on')">
                    <span class="material-icons">play_arrow</span>
                    –í–∫–ª—é—á–∏—Ç—å
                </button>
                <button class="btn btn-primary" onclick="sendCommand('pump', 'off')">
                    <span class="material-icons">stop</span>
                    –í—ã–∫–ª—é—á–∏—Ç—å
                </button>
            </div>
            
            <div class="control-item" style="margin-top: 15px;">
                <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –ø–æ–ª–∏–≤–∞ (—Å–µ–∫)</label>
                <input id="manual_pump_time" type="number" min="5" max="300" value="10" onchange="sendCommand('manual_pump_time', this.value)">
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">lightbulb</span>
                    –°–≤–µ—Ç
                </div>
                <div id="light_status" class="status-badge status-off">–í–´–ö–õ</div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" onclick="sendCommand('light', 'on')">
                    <span class="material-icons">lightbulb</span>
                    –í–∫–ª—é—á–∏—Ç—å
                </button>
                <button class="btn btn-primary" onclick="sendCommand('light', 'off')">
                    <span class="material-icons">lightbulb_outline</span>
                    –í—ã–∫–ª—é—á–∏—Ç—å
                </button>
            </div>
            
            <div class="control-item" style="margin-top: 15px;">
                <label>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–≤–µ—Ç–∞</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input id="lamp_start" type="time" value="08:00" onchange="sendCommand('lamp_start', this.value)">
                    <input id="lamp_end" type="time" value="20:00" onchange="sendCommand('lamp_end', this.value)">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="material-icons">settings</span>
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </div>
            </div>
            
            <div class="control-item">
                <label style="display: flex; align-items: center; justify-content: space-between;">
                    <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</span>
                    <label class="switch">
                        <input id="telegram_notifications" type="checkbox" onchange="sendCommand('telegram_notifications', this.checked ? 'on' : 'off')">
                        <span class="slider-switch"></span>
                    </label>
                </label>
            </div>
            
            <div class="control-item">
                <label>–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ª–∏–≤–∞–º–∏ (–º–∏–Ω)</label>
                <input id="watering_delay" type="number" min="5" max="1440" value="30" onchange="sendCommand('watering_delay', this.value)">
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="refreshData()">
                    <span class="material-icons">refresh</span>
                    –û–±–Ω–æ–≤–∏—Ç—å
                </button>
                <button class="btn btn-success" onclick="sendCommand('pump_auto', '')">
                    <span class="material-icons">autorenew</span>
                    –ê–≤—Ç–æ—Ä–µ–∂–∏–º
                </button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        const BOT_TOKEN = "8365221747:AAEskXtc6T-IhEik718wJJ9x-vz_TOh26tw";
        let CHAT_ID = "6712996693";
        let chart = null;
        let isConnected = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        function initApp() {
            // –ü–æ–ª—É—á–∞–µ–º Chat ID –∏–∑ Telegram –∏–ª–∏ localStorage
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                const tg = Telegram.WebApp;
                tg.expand();
                
                if (tg.initDataUnsafe.user) {
                    CHAT_ID = tg.initDataUnsafe.user.id.toString();
                }
                if (tg.initDataUnsafe.start_param) {
                    CHAT_ID = tg.initDataUnsafe.start_param;
                }
            }
            
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ localStorage
            const savedId = localStorage.getItem('ecogrow_chat_id');
            if (savedId) CHAT_ID = savedId;
            
            localStorage.setItem('ecogrow_chat_id', CHAT_ID);
            
            initChart();
            refreshData();
            setInterval(refreshData, 30000);
        }
        
        function initChart() {
            const ctx = document.getElementById('moist_chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å %',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100 },
                        x: { display: false }
                    }
                }
            });
        }
        
        async function sendCommand(cmd, value) {
            showNotification('–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã...');
            
            try {
                const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                const text = `WEBAPP:${cmd}=${value}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: text,
                        parse_mode: "HTML"
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    showNotification('–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
                    setTimeout(refreshData, 2000);
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + data.description, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }
        
        async function refreshData() {
            try {
                const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: "/data",
                        parse_mode: "HTML"
                    })
                });
                
                const telegramData = await response.json();
                
                if (telegramData.ok) {
                    const text = telegramData.result.text;
                    
                    if (text.startsWith("WEBAPP_DATA:")) {
                        const jsonStr = text.substring(12);
                        const data = JSON.parse(jsonStr);
                        
                        updateUI(data);
                        isConnected = true;
                        document.getElementById('connection_status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                        document.getElementById('connection_status').className = 'status-badge status-on';
                    } else {
                        // –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                        parseTextResponse(text);
                    }
                } else {
                    throw new Error(telegramData.description);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                isConnected = false;
                document.getElementById('connection_status').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                document.getElementById('connection_status').className = 'status-badge status-off';
                
                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π API
                tryLocalApi();
            }
        }
        
        function tryLocalApi() {
            // –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            const localIps = [
                'ecogrow.local',
                '192.168.1.100',
                '192.168.1.101',
                '192.168.0.100'
            ];
            
            localIps.forEach(ip => {
                fetch(`http://${ip}/api/data`)
                    .then(response => {
                        if (response.ok) return response.json();
                        throw new Error();
                    })
                    .then(data => {
                        updateUI(data);
                        isConnected = true;
                        document.getElementById('connection_status').textContent = '–õ–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
                        document.getElementById('connection_status').className = 'status-badge status-on';
                    })
                    .catch(() => {});
            });
        }
        
        function parseTextResponse(text) {
            // –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞
            const moistureMatch = text.match(/–í–ª–∞–∂–Ω–æ—Å—Ç—å:\s*\*?(\d+)%/);
            const pumpMatch = text.match(/–ù–∞—Å–æ—Å:\s*(‚úÖ –í–ö–õ|‚ùå –í–´–ö–õ)/);
            const lightMatch = text.match(/–°–≤–µ—Ç:\s*(‚úÖ –í–ö–õ|‚ùå –í–´–ö–õ)/);
            const thresholdMatch = text.match(/–ü–æ—Ä–æ–≥:\s*(\d+)%/);
            
            const data = {
                moisture: moistureMatch ? parseInt(moistureMatch[1]) : 0,
                pump: pumpMatch ? pumpMatch[1].includes('‚úÖ') : false,
                light: lightMatch ? lightMatch[1].includes('‚úÖ') : false,
                moisture_threshold: thresholdMatch ? parseInt(thresholdMatch[1]) : 50
            };
            
            updateUI(data);
        }
        
        function updateUI(data) {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:', data);
            
            // –í–ª–∞–∂–Ω–æ—Å—Ç—å
            if (data.moisture !== undefined) {
                document.getElementById('moist_status').textContent = data.moisture + '%';
                document.getElementById('current_moist').textContent = data.moisture + '%';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
                if (chart) {
                    if (data.moisture_history && Array.isArray(data.moisture_history)) {
                        chart.data.datasets[0].data = data.moisture_history;
                        const labels = [];
                        for (let i = 0; i < data.moisture_history.length; i++) labels.push('');
                        chart.data.labels = labels;
                        chart.update();
                    } else {
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤ –≥—Ä–∞—Ñ–∏–∫
                        chart.data.datasets[0].data.push(data.moisture);
                        if (chart.data.datasets[0].data.length > 20) {
                            chart.data.datasets[0].data.shift();
                        }
                        chart.data.labels.push('');
                        if (chart.data.labels.length > 20) {
                            chart.data.labels.shift();
                        }
                        chart.update();
                    }
                }
            }
            
            // –°—Ä–µ–¥–Ω—è—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å
            if (data.avg_moisture !== undefined) {
                document.getElementById('avg_moist').textContent = data.avg_moisture + '%';
            }
            
            // –ù–∞—Å–æ—Å
            if (data.pump !== undefined) {
                document.getElementById('pump_status').textContent = data.pump ? '–í–ö–õ' : '–í–´–ö–õ';
                document.getElementById('pump_status').className = 'status-badge ' + (data.pump ? 'status-on' : 'status-off');
            }
            
            // –°–≤–µ—Ç
            if (data.light !== undefined) {
                document.getElementById('light_status').textContent = data.light ? '–í–ö–õ' : '–í–´–ö–õ';
                document.getElementById('light_status').className = 'status-badge ' + (data.light ? 'status-on' : 'status-off');
            }
            
            // –ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
            if (data.moisture_threshold !== undefined) {
                document.getElementById('moist_threshold').value = data.moisture_threshold;
                document.getElementById('thresh_val').textContent = data.moisture_threshold + '%';
            }
            
            // –í—Ä–µ–º—è —Ä—É—á–Ω–æ–≥–æ –Ω–∞—Å–æ—Å–∞
            if (data.manual_pump_time !== undefined) {
                document.getElementById('manual_pump_time').value = data.manual_pump_time;
            }
            
            // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ª–∞–º–ø—ã
            if (data.lamp_start) {
                document.getElementById('lamp_start').value = data.lamp_start;
            }
            if (data.lamp_end) {
                document.getElementById('lamp_end').value = data.lamp_end;
            }
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–∏–≤–∞
            if (data.watering_delay !== undefined) {
                document.getElementById('watering_delay').value = data.watering_delay;
            }
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            if (data.telegram_notifications !== undefined) {
                document.getElementById('telegram_notifications').checked = data.telegram_notifications;
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show';
            
            if (type === 'error') {
                notification.style.borderLeftColor = '#e74c3c';
            } else if (type === 'success') {
                notification.style.borderLeftColor = '#27ae60';
            } else {
                notification.style.borderLeftColor = '#3498db';
            }
            
            setTimeout(() => {
                notification.className = 'notification';
            }, 3000);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('moist_threshold').addEventListener('input', function(e) {
            document.getElementById('thresh_val').textContent = e.target.value + '%';
        });
        
        document.getElementById('moist_threshold').addEventListener('change', function(e) {
            sendCommand('threshold', e.target.value);
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = function() {
            setTimeout(refreshData, 1000);
        };
    </script>
</body>
</html>
