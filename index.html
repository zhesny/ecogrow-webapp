<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üå± EcoGrow Control Panel</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Manifest –¥–ª—è PWA -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* ===== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ===== */
        :root {
            /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
            --bg-primary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-green: #27ae60;
            --accent-blue: #3498db;
            --accent-red: #e74c3c;
            --accent-orange: #f39c12;
            --accent-purple: #9b59b6;
            --border-color: #e1e8ed;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --gradient-primary: linear-gradient(135deg, #27ae60, #2ecc71);
            --gradient-blue: linear-gradient(135deg, #3498db, #2980b9);
            --gradient-purple: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --border-color: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
            --gradient-primary: linear-gradient(135deg, #2ecc71, #27ae60);
            --gradient-blue: linear-gradient(135deg, #2980b9, #3498db);
            --gradient-purple: linear-gradient(135deg, #8e44ad, #9b59b6);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }
        
        /* ===== HEADER ===== */
        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
            flex: 1;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .app-subtitle {
            opacity: 0.9;
            font-size: 1rem;
            font-weight: 400;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            position: relative;
            z-index: 1;
        }
        
        /* ===== –ö–ê–†–¢–û–ß–ö–ò ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
            width: 100%;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .wide-card {
            grid-column: 1 / -1;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            min-width: 80px;
            text-align: center;
        }
        
        .status-on {
            background: rgba(39, 174, 96, 0.15);
            color: var(--accent-green);
        }
        
        .status-off {
            background: rgba(243, 156, 18, 0.15);
            color: var(--accent-orange);
        }
        
        .status-error {
            background: rgba(231, 76, 60, 0.15);
            color: var(--accent-red);
        }
        
        /* ===== –ì–†–ê–§–ò–ö ===== */
        .chart-container {
            height: 250px;
            margin: 20px 0;
            position: relative;
            width: 100%;
        }
        
        /* ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            background: var(--gradient-primary);
            color: white;
            transform: scale(1.05);
        }
        
        .stat-card:hover .stat-value,
        .stat-card:hover .stat-label {
            color: white;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 5px;
            transition: color 0.3s;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s;
        }
        
        /* ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï ===== */
        .control-group {
            margin: 20px 0;
        }
        
        .control-item {
            margin-bottom: 15px;
        }
        
        .control-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: var(--accent-blue);
            font-size: 1.1rem;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            border: 3px solid var(--bg-card);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        input[type="number"],
        input[type="time"],
        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            border-color: var(--accent-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        /* ===== –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–ò ===== */
        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .switch-row:last-child {
            border-bottom: none;
        }
        
        .switch-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .switch-label .subtext {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider-switch {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 34px;
            transition: .4s;
        }
        
        .slider-switch:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        
        input:checked + .slider-switch {
            background-color: var(--accent-green);
        }
        
        input:checked + .slider-switch:before {
            transform: translateX(30px);
        }
        
        /* ===== –ö–ù–û–ü–ö–ò ===== */
        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--gradient-blue);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }
        
        .btn-secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }
        
        /* ===== –¢–ê–ô–ú–ï–† ===== */
        .timer-display {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.08), rgba(46, 204, 113, 0.12));
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            border: 2px solid rgba(39, 174, 96, 0.15);
        }
        
        .timer-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-green);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            line-height: 1;
        }
        
        .timer-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        /* ===== –û–®–ò–ë–ö–ò ===== */
        .errors-list {
            max-height: 250px;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 10px;
        }
        
        .error-item {
            background: rgba(231, 76, 60, 0.08);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-red);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .error-time {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--accent-red);
            font-size: 0.9rem;
        }
        
        .error-msg {
            color: var(--text-primary);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* ===== TELEGRAM CARD ===== */
        .telegram-card {
            background: var(--gradient-blue);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            grid-column: 1 / -1;
        }
        
        /* ===== –ù–ê–°–¢–†–û–ô–ö–ò –í–†–ï–ú–ï–ù–ò ===== */
        .time-input-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .compact-input-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .time-display {
            font-size: 1.2rem;
            color: var(--accent-blue);
            font-weight: 600;
            text-align: center;
            margin: 15px 0;
            padding: 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 12px;
        }
        
        /* ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            border-left: 4px solid var(--accent-green);
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 350px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notification.error {
            border-left-color: var(--accent-red);
        }
        
        .notification.warning {
            border-left-color: var(--accent-orange);
        }
        
        .notification.info {
            border-left-color: var(--accent-blue);
        }
        
        /* ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalIn 0.3s ease-out;
        }
        
        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: var(--accent-red);
        }
        
        /* ===== –ì–û–õ–û–°–û–í–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï ===== */
        .voice-control {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-purple);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.3);
            transition: all 0.3s;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-control.listening {
            animation: pulse 1.5s infinite;
            background: var(--accent-red);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(231, 76, 60, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        /* ===== FAB –ö–ù–û–ü–ö–ò ===== */
        .fab-container {
            position: fixed;
            bottom: 100px;
            right: 25px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .fab-refresh {
            background: var(--gradient-blue);
        }
        
        .fab-theme {
            background: var(--gradient-purple);
        }
        
        .fab-settings {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        /* ===== –¢–ï–ú–ê –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø ===== */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                max-width: 100%;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
                padding: 20px;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-group {
                grid-template-columns: 1fr;
            }
            
            .time-input-group,
            .compact-input-group {
                grid-template-columns: 1fr;
            }
            
            .fab-container {
                bottom: 90px;
                right: 15px;
            }
            
            .voice-control {
                bottom: 20px;
                left: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }
            
            .notification {
                top: 15px;
                right: 15px;
                left: 15px;
                max-width: none;
            }
            
            /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            body {
                overflow-x: hidden;
                width: 100%;
            }
            
            .card {
                padding: 20px;
            }
            
            .app-title {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 20px;
            }
            
            .app-title {
                font-size: 1.3rem;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
            
            .timer-value {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
        }
        
        /* ===== –ü–†–û–ì–†–ï–°–° –ë–ê–† ===== */
        .progress-bar {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.5s ease-out;
            border-radius: 4px;
        }
        
        /* ===== –ó–ê–ì–†–£–ó–ö–ê ===== */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== –°–ö–†–û–õ–õ–ë–ê–† ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-green);
        }
        
        /* ===== –¢–£–õ–¢–ò–ü–´ ===== */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: var(--bg-card);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 10px);
        }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            
            <div class="control-group">
                <div class="control-item">
                    <label>ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (Chat ID)</label>
                    <input type="text" id="settingsDeviceId" placeholder="6712996693">
                </div>
                
                <div class="control-item">
                    <label>–¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞</label>
                    <input type="password" id="settingsBotToken" 
                           placeholder="8365221747:AAEskXtc6T-IhEik718wJJ9x-vz_TOh26tw">
                </div>
                
                <div class="control-item">
                    <label>–õ–æ–∫–∞–ª—å–Ω—ã–π IP –∞–¥—Ä–µ—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" id="settingsLocalIp" placeholder="192.168.1.100 –∏–ª–∏ ecogrow.local">
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram Web App</span>
                        <span class="subtext">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="settingsUseTelegram" checked>
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span>–í–∫–ª—é—á–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
                        <span class="subtext">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ Chrome –∏ Edge</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="settingsVoiceControl">
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span>–í–∫–ª—é—á–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                        <span class="subtext">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="settingsNotifications">
                        <span class="slider-switch"></span>
                    </label>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveSettings()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="btn btn-secondary" onclick="loadDefaultSettings()">
                    –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                </button>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="material-icons">eco</span>
                    EcoGrow Control Panel
                </h1>
                <p class="app-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª–∏–≤–∞ –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –º–∏—Ä–∞</p>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                    <span class="material-icons">dark_mode</span>
                    –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
                </button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ -->
        <div class="grid">
            <!-- –ì—Ä–∞—Ñ–∏–∫ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ -->
            <div class="card wide-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">show_chart</span>
                        –ì—Ä–∞—Ñ–∏–∫ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
                    </div>
                    <div id="moist_status" class="status-badge">--%</div>
                </div>
                
                <div class="chart-container">
                    <canvas id="moist_chart"></canvas>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div id="current_moist" class="stat-value">--%</div>
                        <div class="stat-label">–¢–µ–∫—É—â–∞—è</div>
                    </div>
                    <div class="stat-card">
                        <div id="avg_moist" class="stat-value">--%</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω—è—è</div>
                    </div>
                    <div class="stat-card">
                        <div id="min_moist" class="stat-value">--%</div>
                        <div class="stat-label">–ú–∏–Ω–∏–º—É–º</div>
                    </div>
                </div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–º -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">water_drop</span>
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–º
                    </div>
                    <div id="pump_status" class="status-badge status-off">–í–´–ö–õ</div>
                </div>
                
                <div class="control-group">
                    <div class="control-item">
                        <label>–ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏: <span id="thresh_val" class="slider-value">50%</span></label>
                        <div class="slider-container">
                            <input id="moist_threshold" type="range" min="10" max="90" step="1" value="50">
                        </div>
                    </div>
                    
                    <div class="control-item">
                        <label>–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ª–∏–≤–∞–º–∏ (–º–∏–Ω—É—Ç)</label>
                        <input id="watering_delay" type="number" min="5" max="1440" step="5" value="30">
                    </div>
                    
                    <div class="control-item">
                        <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞ (—Å–µ–∫—É–Ω–¥)</label>
                        <input id="watering_duration" type="number" min="1" max="300" step="1" value="2">
                    </div>
                    
                    <div class="control-item">
                        <label>–í—Ä–µ–º—è —Ä—É—á–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥)</label>
                        <input id="manual_pump_time" type="number" min="5" max="300" step="5" value="10">
                    </div>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span style="font-weight: 500;">–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
                        <span id="pump_mode" class="subtext">–†–µ–∂–∏–º: –ê–í–¢–û</span>
                    </div>
                    <label class="switch">
                        <input id="pump_switch" type="checkbox">
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="manualWatering()">
                        <span class="material-icons">play_circle</span>
                        –ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å
                    </button>
                    <button class="btn btn-secondary" onclick="setPumpAuto()">
                        <span class="material-icons">autorenew</span>
                        –ê–≤—Ç–æ—Ä–µ–∂–∏–º
                    </button>
                </div>
                
                <div class="timer-display">
                    <div id="timer_value" class="timer-value">--</div>
                    <div class="timer-label">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª–∏–≤–∞ (–º–∏–Ω—É—Ç)</div>
                </div>
            </div>

            <!-- –§–∏—Ç–æ–ª–∞–º–ø–∞ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">lightbulb</span>
                        –§–∏—Ç–æ–ª–∞–º–ø–∞
                    </div>
                    <div id="light_status" class="status-badge status-off">–í–´–ö–õ</div>
                </div>
                
                <div class="control-group">
                    <div class="time-input-group">
                        <div class="control-item">
                            <label>–í–∫–ª—é—á–µ–Ω–∏–µ</label>
                            <input id="lamp_start" type="time" value="08:00">
                        </div>
                        <div class="control-item">
                            <label>–í—ã–∫–ª—é—á–µ–Ω–∏–µ</label>
                            <input id="lamp_end" type="time" value="20:00">
                        </div>
                    </div>
                    
                    <div class="control-item">
                        <label>–í—Ä–µ–º—è —Ä—É—á–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è (—á–∞—Å–æ–≤)</label>
                        <input id="manual_light_time" type="number" min="1" max="24" step="1" value="1">
                    </div>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span style="font-weight: 500;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
                        <span class="subtext">–ê–≤—Ç–æ–≤–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</span>
                    </div>
                    <label class="switch">
                        <input id="lamp_enabled" type="checkbox" checked>
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span style="font-weight: 500;">–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
                        <span id="light_mode" class="subtext">–†–µ–∂–∏–º: –ê–í–¢–û</span>
                    </div>
                    <label class="switch">
                        <input id="light_switch" type="checkbox">
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="setLightAuto()">
                        <span class="material-icons">autorenew</span>
                        –ê–≤—Ç–æ—Ä–µ–∂–∏–º —Å–≤–µ—Ç–∞
                    </button>
                </div>
            </div>

            <!-- –†–µ–∂–∏–º —Å–Ω–∞ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">bedtime</span>
                        –†–µ–∂–∏–º —Å–Ω–∞
                    </div>
                    <div id="sleep_status" class="status-badge status-off">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</div>
                </div>
                
                <div class="control-group">
                    <div class="time-input-group">
                        <div class="control-item">
                            <label>–ù–∞—á–∞–ª–æ</label>
                            <input id="sleep_start" type="time" value="23:00">
                        </div>
                        <div class="control-item">
                            <label>–ö–æ–Ω–µ—Ü</label>
                            <input id="sleep_end" type="time" value="07:00">
                        </div>
                    </div>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span style="font-weight: 500;">–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Å–Ω–∞</span>
                        <span class="subtext">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ</span>
                    </div>
                    <label class="switch">
                        <input id="sleep_enabled" type="checkbox">
                        <span class="slider-switch"></span>
                    </label>
                </div>
            </div>

            <!-- –û—à–∏–±–∫–∏ —Å–∏—Å—Ç–µ–º—ã -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">error</span>
                        –û—à–∏–±–∫–∏ —Å–∏—Å—Ç–µ–º—ã
                    </div>
                    <div id="error_count" class="status-badge">0</div>
                </div>
                
                <div id="errors_container" class="errors-list">
                    <div class="error-item">
                        <div class="error-time">üïê --:--</div>
                        <div class="error-msg">–û—à–∏–±–æ–∫ –Ω–µ—Ç</div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-danger" onclick="clearErrors()">
                        <span class="material-icons">delete</span>
                        –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                    <button class="btn btn-primary" onclick="refreshErrors()">
                        <span class="material-icons">refresh</span>
                        –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">analytics</span>
                        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div id="total_waterings" class="stat-value">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª–∏–≤–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div id="total_light_hours" class="stat-value">0</div>
                        <div class="stat-label">–ß–∞—Å–æ–≤ —Å–≤–µ—Ç–∞</div>
                    </div>
                    <div class="stat-card">
                        <div id="energy_consumption" class="stat-value">0</div>
                        <div class="stat-label">–í—Ç¬∑—á</div>
                    </div>
                </div>
            </div>

            <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="material-icons">schedule</span>
                        –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
                    </div>
                    <div id="time_mode" class="status-badge">–ê–≤—Ç–æ</div>
                </div>
                
                <div class="time-display" id="current_time_display">
                    –¢–µ–∫—É—â–µ–µ: --:--
                </div>
                
                <div class="compact-input-group">
                    <div class="control-item">
                        <label>–ß–∞—Å—ã (0-23)</label>
                        <input id="time_hours" type="number" min="0" max="23" step="1" value="12">
                    </div>
                    <div class="control-item">
                        <label>–ú–∏–Ω—É—Ç—ã (0-59)</label>
                        <input id="time_minutes" type="number" min="0" max="59" step="1" value="0">
                    </div>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span style="font-weight: 500;">–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</span>
                        <span class="subtext">–î–æ–±–∞–≤–∏—Ç—å –∫ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏</span>
                    </div>
                    <label class="switch">
                        <input id="time_manual" type="checkbox">
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ -->
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="setCustomTime()">
                        <span class="material-icons">edit</span>
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è
                    </button>
                    <button class="btn btn-success" onclick="setCurrentTime()">
                        <span class="material-icons">schedule</span>
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å
                    </button>
                </div>
            </div>

            <!-- Telegram –∫–∞—Ä—Ç–æ—á–∫–∞ -->
            <div class="telegram-card">
                <h3 style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span class="material-icons">telegram</span>
                    Telegram –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                </h3>
                <p style="margin-bottom: 15px; font-size: 1rem; opacity: 0.9;">
                    –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–∏—Å—Ç–µ–º–æ–π –∏–∑ Telegram –∏–ª–∏ —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç —Å–∞–π—Ç
                </p>
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="openTelegramBot()" style="flex: 1;">
                        <span class="material-icons">open_in_new</span>
                        –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞
                    </button>
                    <button class="btn btn-primary" onclick="openModal('settingsModal')" style="flex: 1;">
                        <span class="material-icons">settings</span>
                        –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB –∫–Ω–æ–ø–∫–∏ -->
    <div class="fab-container">
        <button class="fab fab-refresh" onclick="refreshData()" data-tooltip="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
            <span class="material-icons">refresh</span>
        </button>
        <button class="fab fab-theme" onclick="toggleTheme()" data-tooltip="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
            <span class="material-icons" id="themeIcon">dark_mode</span>
        </button>
        <button class="fab fab-settings" onclick="openModal('settingsModal')" data-tooltip="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
            <span class="material-icons">settings</span>
        </button>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <button class="voice-control" id="voiceControl" data-tooltip="–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
        <span class="material-icons">mic</span>
    </button>

    <script>
        // ===== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
        const DEFAULT_BOT_TOKEN = "8365221747:AAEskXtc6T-IhEik718wJJ9x-vz_TOh26tw";
        const DEFAULT_CHAT_ID = "6712996693";
        
        let chart = null;
        let isConnected = false;
        let pollingInterval = null;
        let voiceRecognition = null;
        let currentTheme = 'light';
        let deviceSettings = {};
        let lastFetchTime = 0;
        
        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        function initApp() {
            // 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã
            loadTheme();
            
            // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
            initTelegramWebApp();
            
            // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            initChart();
            
            // 4. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            loadSettings();
            
            // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            initVoiceControl();
            
            // 6. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
            registerServiceWorker();
            
            // 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            testConnection();
            
            // 8. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
            updateTime();
            setInterval(updateTime, 60000);
            
            // 9. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
            
            // 10. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            startPolling();
        }
        
        // ===== TELEGRAM WEB APP =====
        function initTelegramWebApp() {
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.expand();
                tg.enableClosingConfirmation();
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram
                const initData = tg.initDataUnsafe;
                if (initData.user) {
                    const chatId = initData.user.id;
                    localStorage.setItem('chat_id', chatId);
                    document.getElementById('settingsDeviceId').value = chatId;
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å start_param, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ deviceId
                if (tg.initDataUnsafe.start_param) {
                    const deviceId = tg.initDataUnsafe.start_param;
                    localStorage.setItem('device_id', deviceId);
                    document.getElementById('settingsDeviceId').value = deviceId;
                }
            }
        }
        
        // ===== –¢–ï–ú–ê =====
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }
        
        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeIcon = document.getElementById('themeIcon');
            const themeToggle = document.getElementById('themeToggle');
            
            if (theme === 'dark') {
                themeIcon.textContent = 'light_mode';
                themeToggle.innerHTML = '<span class="material-icons">light_mode</span> –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
            } else {
                themeIcon.textContent = 'dark_mode';
                themeToggle.innerHTML = '<span class="material-icons">dark_mode</span> –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
            }
        }
        
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
            showNotification('–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ' + (newTheme === 'dark' ? '—Ç—ë–º–Ω—É—é' : '—Å–≤–µ—Ç–ª—É—é'), 'info');
        }
        
        // ===== –ì–†–ê–§–ò–ö =====
        function initChart() {
            const ctx = document.getElementById('moist_chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å %',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        pointBackgroundColor: 'transparent',
                        pointBorderColor: 'transparent'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 13 },
                            bodyFont: { size: 13 },
                            padding: 10,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(0, 0, 0, 0.08)' },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: { size: 11 },
                                padding: 5
                            }
                        },
                        x: { display: false }
                    },
                    interaction: { intersect: false },
                    animation: { duration: 800 }
                }
            });
        }
        
        // ===== –ì–û–õ–û–°–û–í–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï =====
        function initVoiceControl() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                voiceRecognition = new SpeechRecognition();
                voiceRecognition.lang = 'ru-RU';
                voiceRecognition.continuous = false;
                voiceRecognition.interimResults = false;
                
                voiceRecognition.onstart = function() {
                    document.getElementById('voiceControl').classList.add('listening');
                    showNotification('–°–ª—É—à–∞—é...', 'info');
                };
                
                voiceRecognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    processVoiceCommand(transcript);
                };
                
                voiceRecognition.onerror = function(event) {
                    console.error('Voice recognition error', event.error);
                    document.getElementById('voiceControl').classList.remove('listening');
                    showNotification('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞', 'error');
                };
                
                voiceRecognition.onend = function() {
                    document.getElementById('voiceControl').classList.remove('listening');
                };
                
                document.getElementById('voiceControl').addEventListener('click', function() {
                    if (localStorage.getItem('voice_enabled') === 'true') {
                        voiceRecognition.start();
                    } else {
                        showNotification('–í–∫–ª—é—á–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'warning');
                    }
                });
            } else {
                document.getElementById('voiceControl').style.display = 'none';
            }
        }
        
        function processVoiceCommand(command) {
            console.log('Voice command:', command);
            
            if (command.includes('–≤–∫–ª—é—á–∏ –Ω–∞—Å–æ—Å') || command.includes('–ø–æ–ª–∏–≤')) {
                sendCommand('pump', 'on');
                showNotification('–ù–∞—Å–æ—Å –≤–∫–ª—é—á—ë–Ω', 'success');
            } else if (command.includes('–≤—ã–∫–ª—é—á–∏ –Ω–∞—Å–æ—Å') || command.includes('—Å—Ç–æ–ø –ø–æ–ª–∏–≤')) {
                sendCommand('pump', 'off');
                showNotification('–ù–∞—Å–æ—Å –≤—ã–∫–ª—é—á–µ–Ω', 'success');
            } else if (command.includes('–≤–∫–ª—é—á–∏ —Å–≤–µ—Ç') || command.includes('–ª–∞–º–ø–∞')) {
                sendCommand('light', 'on');
                showNotification('–°–≤–µ—Ç –≤–∫–ª—é—á—ë–Ω', 'success');
            } else if (command.includes('–≤—ã–∫–ª—é—á–∏ —Å–≤–µ—Ç')) {
                sendCommand('light', 'off');
                showNotification('–°–≤–µ—Ç –≤—ã–∫–ª—é—á–µ–Ω', 'success');
            } else if (command.includes('–∞–≤—Ç–æ —Ä–µ–∂–∏–º')) {
                sendCommand('pump_auto', '');
                showNotification('–í–∫–ª—é—á—ë–Ω –∞–≤—Ç–æ—Ä–µ–∂–∏–º', 'success');
            } else if (command.includes('—Å—Ç–∞—Ç—É—Å') || command.includes('–∫–∞–∫ –¥–µ–ª–∞')) {
                fetchDeviceData();
                showNotification('–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å...', 'info');
            } else {
                showNotification('–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞: ' + command, 'warning');
            }
        }
        
        // ===== PWA –ò SERVICE WORKER =====
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
                        if ('PushManager' in window) {
                            requestNotificationPermission();
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', error);
                    });
            }
        }
        
        function requestNotificationPermission() {
            if (localStorage.getItem('notifications_enabled') === 'true') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('–†–∞–∑—Ä–µ—à–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                    }
                });
            }
        }
        
        // ===== –û–¢–ü–†–ê–í–ö–ê –ö–û–ú–ê–ù–î =====
        async function sendCommand(cmd, value) {
            const deviceId = localStorage.getItem('device_id') || DEFAULT_CHAT_ID;
            const botToken = localStorage.getItem('bot_token') || DEFAULT_BOT_TOKEN;
            const localIp = localStorage.getItem('local_ip') || '';
            
            if (!deviceId) {
                showNotification('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'error');
                return;
            }
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                if (localIp) {
                    try {
                        const response = await fetch(`http://${localIp}/webapp/command`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                device_id: deviceId,
                                cmd: cmd,
                                param: value
                            })
                        });
                        
                        if (response.ok) {
                            showNotification('–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ', 'success');
                            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                            setTimeout(fetchDeviceData, 2000);
                            return;
                        }
                    } catch (e) {
                        console.log('–õ–æ–∫–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:', e);
                    }
                }
                
                // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ Telegram
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                const text = `WEBAPP:${cmd}=${value}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: deviceId,
                        text: text,
                        parse_mode: "HTML"
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    showNotification('–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ Telegram', 'success');
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(fetchDeviceData, 2000);
                } else {
                    throw new Error(data.description || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // ===== –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• =====
        async function fetchDeviceData() {
            const now = Date.now();
            if (now - lastFetchTime < 5000) { // –ù–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 5 —Å–µ–∫—É–Ω–¥
                console.log('–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å, —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ');
                return;
            }
            lastFetchTime = now;
            
            const deviceId = localStorage.getItem('device_id') || DEFAULT_CHAT_ID;
            const botToken = localStorage.getItem('bot_token') || DEFAULT_BOT_TOKEN;
            const localIp = localStorage.getItem('local_ip') || '';
            
            if (!deviceId) {
                showNotification('–£–∫–∞–∂–∏—Ç–µ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'warning');
                return;
            }
            
            try {
                let data = null;
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                if (localIp) {
                    try {
                        console.log('–ü—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫:', localIp);
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const response = await fetch(`http://${localIp}/webapp/data`, {
                            signal: controller.signal,
                            mode: 'cors'
                        });
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            data = await response.json();
                            isConnected = true;
                            console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ:', data);
                            updateUI(data);
                            return;
                        }
                    } catch (e) {
                        console.log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:', e.message);
                    }
                }
                
                // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ Telegram
                console.log('–ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Telegram...');
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: deviceId,
                        text: "/status", // –ò—Å–ø–æ–ª—å–∑—É–µ–º /status –≤–º–µ—Å—Ç–æ /webapp_data
                        parse_mode: "Markdown"
                    })
                });
                
                const telegramData = await response.json();
                console.log('–û—Ç–≤–µ—Ç –æ—Ç Telegram:', telegramData);
                
                if (telegramData.ok) {
                    isConnected = true;
                    // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –æ—Ç /status –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    const text = telegramData.result.text;
                    const moistureMatch = text.match(/–í–ª–∞–∂–Ω–æ—Å—Ç—å:\s*\*(\d+)%\*/);
                    const pumpMatch = text.match(/–ù–∞—Å–æ—Å:\s*(‚úÖ –í–ö–õ|‚ùå –í–´–ö–õ)/);
                    const lightMatch = text.match(/–°–≤–µ—Ç:\s*(‚úÖ –í–ö–õ|‚ùå –í–´–ö–õ)/);
                    const thresholdMatch = text.match(/–ü–æ—Ä–æ–≥:\s*(\d+)%/);
                    const timeMatch = text.match(/–í—Ä–µ–º—è:\s*(\d{2}:\d{2})/);
                    
                    data = {
                        moisture: moistureMatch ? parseInt(moistureMatch[1]) : 0,
                        pump: pumpMatch ? pumpMatch[1].includes('‚úÖ') : false,
                        light: lightMatch ? lightMatch[1].includes('‚úÖ') : false,
                        moisture_threshold: thresholdMatch ? parseInt(thresholdMatch[1]) : 50,
                        current_time: timeMatch ? timeMatch[1] : '--:--'
                    };
                    
                    console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ Telegram:', data);
                    updateUI(data);
                } else {
                    throw new Error(telegramData.description || '–û—à–∏–±–∫–∞ Telegram API');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                isConnected = false;
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É', 'error');
            }
        }
        
        // ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê =====
        function updateUI(data) {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å –¥–∞–Ω–Ω—ã–º–∏:', data);
            
            // –í–ª–∞–∂–Ω–æ—Å—Ç—å
            if (data.moisture !== undefined) {
                document.getElementById('moist_status').textContent = data.moisture + '%';
                document.getElementById('current_moist').textContent = data.moisture + '%';
                
                // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
                if (data.moisture < 30) {
                    document.getElementById('moist_status').className = 'status-badge status-error';
                } else if (data.moisture < 50) {
                    document.getElementById('moist_status').className = 'status-badge status-off';
                } else {
                    document.getElementById('moist_status').className = 'status-badge status-on';
                }
            }
            
            // –°—Ä–µ–¥–Ω—è—è –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å
            if (data.avg_moisture !== undefined) {
                document.getElementById('avg_moist').textContent = data.avg_moisture + '%';
            }
            if (data.min_moisture !== undefined) {
                document.getElementById('min_moist').textContent = data.min_moisture + '%';
            }
            
            // –ù–∞—Å–æ—Å
            if (data.pump !== undefined) {
                const pumpStatus = document.getElementById('pump_status');
                pumpStatus.textContent = data.pump ? '–í–ö–õ' : '–í–´–ö–õ';
                pumpStatus.className = 'status-badge ' + (data.pump ? 'status-on' : 'status-off');
                document.getElementById('pump_switch').checked = data.pump;
                if (data.manual_pump !== undefined) {
                    document.getElementById('pump_mode').textContent = '–†–µ–∂–∏–º: ' + (data.manual_pump ? '–†–£–ß–ù–û–ô' : '–ê–í–¢–û');
                }
            }
            
            // –°–≤–µ—Ç
            if (data.light !== undefined) {
                const lightStatus = document.getElementById('light_status');
                lightStatus.textContent = data.light ? '–í–ö–õ' : '–í–´–ö–õ';
                lightStatus.className = 'status-badge ' + (data.light ? 'status-on' : 'status-off');
                document.getElementById('light_switch').checked = data.light;
                if (data.manual_light !== undefined) {
                    document.getElementById('light_mode').textContent = '–†–µ–∂–∏–º: ' + (data.manual_light ? '–†–£–ß–ù–û–ô' : '–ê–í–¢–û');
                }
            }
            
            // –ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
            if (data.moisture_threshold !== undefined) {
                document.getElementById('moist_threshold').value = data.moisture_threshold;
                document.getElementById('thresh_val').textContent = data.moisture_threshold + '%';
            }
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–∏–≤–∞
            if (data.watering_delay !== undefined) {
                document.getElementById('watering_delay').value = data.watering_delay;
            }
            
            // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞
            if (data.watering_duration !== undefined) {
                document.getElementById('watering_duration').value = data.watering_duration;
            }
            
            // –í—Ä–µ–º—è —Ä—É—á–Ω–æ–≥–æ –Ω–∞—Å–æ—Å–∞
            if (data.manual_pump_time !== undefined) {
                document.getElementById('manual_pump_time').value = data.manual_pump_time;
            }
            
            // –í—Ä–µ–º—è —Ä—É—á–Ω–æ–≥–æ —Å–≤–µ—Ç–∞
            if (data.manual_light_time !== undefined) {
                document.getElementById('manual_light_time').value = data.manual_light_time;
            }
            
            // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ª–∞–º–ø—ã
            if (data.lamp_start) {
                document.getElementById('lamp_start').value = data.lamp_start;
            }
            if (data.lamp_end) {
                document.getElementById('lamp_end').value = data.lamp_end;
            }
            if (data.lamp_enabled !== undefined) {
                document.getElementById('lamp_enabled').checked = data.lamp_enabled;
            }
            
            // –†–µ–∂–∏–º —Å–Ω–∞
            if (data.sleep_start) {
                document.getElementById('sleep_start').value = data.sleep_start;
            }
            if (data.sleep_end) {
                document.getElementById('sleep_end').value = data.sleep_end;
            }
            if (data.sleep_enabled !== undefined) {
                document.getElementById('sleep_enabled').checked = data.sleep_enabled;
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                const sleepActive = data.sleep_enabled && timeInRange(currentTime, data.sleep_start, data.sleep_end);
                const sleepStatus = document.getElementById('sleep_status');
                sleepStatus.textContent = sleepActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                sleepStatus.className = 'status-badge ' + (sleepActive ? 'status-on' : 'status-off');
            }
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            if (data.total_waterings !== undefined) {
                document.getElementById('total_waterings').textContent = data.total_waterings;
            }
            if (data.total_light_hours !== undefined) {
                document.getElementById('total_light_hours').textContent = data.total_light_hours;
            }
            if (data.total_energy !== undefined) {
                document.getElementById('energy_consumption').textContent = data.total_energy;
            }
            
            // –¢–∞–π–º–µ—Ä –ø–æ–ª–∏–≤–∞
            if (data.time_since_watering !== undefined && data.watering_delay_ms !== undefined) {
                const timeSinceWatering = data.time_since_watering;
                const wateringDelayMs = data.watering_delay_ms;
                const timeLeft = Math.max(0, Math.floor((wateringDelayMs - timeSinceWatering) / 60000));
                document.getElementById('timer_value').textContent = timeLeft;
            }
            
            // –í—Ä–µ–º—è
            if (data.current_time) {
                document.getElementById('current_time_display').textContent = '–¢–µ–∫—É—â–µ–µ: ' + data.current_time;
            }
            if (data.time_manual !== undefined) {
                document.getElementById('time_manual').checked = data.time_manual;
                const timeMode = document.getElementById('time_mode');
                timeMode.textContent = data.time_manual ? '–†—É—á–Ω–æ–µ' : '–ê–≤—Ç–æ';
                timeMode.className = 'status-badge ' + (data.time_manual ? 'status-on' : '');
            }
            
            // –ò—Å—Ç–æ—Ä–∏—è –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
            if (data.moisture_history && Array.isArray(data.moisture_history)) {
                updateChart(data.moisture_history);
            }
            
            // –û—à–∏–±–∫–∏
            if (data.errors) {
                updateErrors(data.errors);
            }
        }
        
        function updateChart(data) {
            if (!chart) initChart();
            
            chart.data.datasets[0].data = data;
            const labels = [];
            for (let i = 0; i < data.length; i++) labels.push('');
            chart.data.labels = labels;
            
            chart.update('none');
        }
        
        function updateErrors(errors) {
            const container = document.getElementById('errors_container');
            const errorCount = document.getElementById('error_count');
            
            if (!errors || errors.length === 0) {
                container.innerHTML = '<div class="error-item"><div class="error-time">üïê --:--</div><div class="error-msg">‚úÖ –û—à–∏–±–æ–∫ –Ω–µ—Ç</div></div>';
                errorCount.textContent = '0';
                errorCount.className = 'status-badge';
                return;
            }
            
            errorCount.textContent = errors.length;
            errorCount.className = 'status-badge status-error';
            
            let html = '';
            errors.forEach(error => {
                html += `
                    <div class="error-item">
                        <div class="error-time">üïê ${error.time}</div>
                        <div class="error-msg">${error.msg}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï =====
        function manualWatering() {
            sendCommand('pump', 'on');
            setTimeout(() => {
                sendCommand('pump', 'off');
            }, 5000);
        }
        
        function setPumpAuto() {
            sendCommand('pump_auto', '');
        }
        
        function setLightAuto() {
            sendCommand('light_auto', '');
        }
        
        function clearErrors() {
            sendCommand('clear_errors', '');
        }
        
        function refreshErrors() {
            fetchDeviceData();
        }
        
        function setCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
            document.getElementById('time_hours').value = hours;
            document.getElementById('time_minutes').value = minutes;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É
            sendCommand('set_time', `${hours}:${minutes}`);
            showNotification(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è: ${hours}:${minutes}`, 'success');
        }
        
        function setCustomTime() {
            const hours = document.getElementById('time_hours').value;
            const minutes = document.getElementById('time_minutes').value;
            const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            
            sendCommand('set_time', timeStr);
            showNotification(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è: ${timeStr}`, 'success');
        }
        
        // ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
        function loadSettings() {
            const deviceId = localStorage.getItem('device_id') || DEFAULT_CHAT_ID;
            const botToken = localStorage.getItem('bot_token') || DEFAULT_BOT_TOKEN;
            const localIp = localStorage.getItem('local_ip') || '';
            const voiceEnabled = localStorage.getItem('voice_enabled') === 'true';
            const notificationsEnabled = localStorage.getItem('notifications_enabled') === 'true';
            
            document.getElementById('settingsDeviceId').value = deviceId;
            document.getElementById('settingsBotToken').value = botToken;
            document.getElementById('settingsLocalIp').value = localIp;
            document.getElementById('settingsVoiceControl').checked = voiceEnabled;
            document.getElementById('settingsNotifications').checked = notificationsEnabled;
        }
        
        function saveSettings() {
            const deviceId = document.getElementById('settingsDeviceId').value.trim();
            const botToken = document.getElementById('settingsBotToken').value.trim();
            const localIp = document.getElementById('settingsLocalIp').value.trim();
            const voiceEnabled = document.getElementById('settingsVoiceControl').checked;
            const notificationsEnabled = document.getElementById('settingsNotifications').checked;
            
            if (!deviceId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', 'error');
                return;
            }
            
            localStorage.setItem('device_id', deviceId);
            localStorage.setItem('bot_token', botToken);
            localStorage.setItem('local_ip', localIp);
            localStorage.setItem('voice_enabled', voiceEnabled);
            localStorage.setItem('notifications_enabled', notificationsEnabled);
            
            closeModal('settingsModal');
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            testConnection();
        }
        
        function loadDefaultSettings() {
            document.getElementById('settingsDeviceId').value = DEFAULT_CHAT_ID;
            document.getElementById('settingsBotToken').value = DEFAULT_BOT_TOKEN;
            document.getElementById('settingsLocalIp').value = '';
            document.getElementById('settingsVoiceControl').checked = true;
            document.getElementById('settingsNotifications').checked = true;
            showNotification('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é', 'info');
        }
        
        // ===== –£–¢–ò–õ–ò–¢–´ =====
        function timeInRange(currentTime, startStr, endStr) {
            const current = timeToMinutes(currentTime);
            const start = timeToMinutes(startStr);
            const end = timeToMinutes(endStr);
            
            if (start <= end) {
                return current >= start && current < end;
            } else {
                return current >= start || current < end;
            }
        }
        
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            const timeDisplay = document.getElementById('current_time_display');
            if (timeDisplay && timeDisplay.textContent.includes('--:--')) {
                timeDisplay.textContent = '–¢–µ–∫—É—â–µ–µ: ' + timeString;
            }
        }
        
        function testConnection() {
            if (localStorage.getItem('device_id')) {
                showNotification('–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
                fetchDeviceData();
            } else {
                showNotification('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'warning');
                setTimeout(() => openModal('settingsModal'), 2000);
            }
        }
        
        function startPolling() {
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(() => {
                if (localStorage.getItem('device_id')) {
                    fetchDeviceData();
                }
            }, 30000);
        }
        
        function refreshData() {
            fetchDeviceData();
            showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
        }
        
        function openTelegramBot() {
            window.open('https://t.me/EcoGrow_assis_Bot', '_blank');
        }
        
        // ===== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê =====
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            setTimeout(() => {
                document.getElementById(modalId).style.opacity = '1';
            }, 10);
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        // ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø =====
        function showNotification(message, type = 'info') {
            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="material-icons">${getNotificationIcon(type)}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                notification.style.transform = 'translateX(120%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (type === 'error' && localStorage.getItem('notifications_enabled') === 'true') {
                sendPushNotification(message);
            }
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check_circle';
                case 'error': return 'error';
                case 'warning': return 'warning';
                default: return 'info';
            }
        }
        
        function sendPushNotification(message) {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification('EcoGrow Alert', {
                        body: message,
                        icon: 'https://img.icons8.com/color/96/000000/plant-under-sun.png',
                        badge: 'https://img.icons8.com/color/96/000000/plant-under-sun.png',
                        vibrate: [200, 100, 200]
                    });
                });
            }
        }
        
        // ===== –°–û–ë–´–¢–ò–Ø =====
        function setupEventListeners() {
            // –°–ª–∞–π–¥–µ—Ä –ø–æ—Ä–æ–≥–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
            document.getElementById('moist_threshold').addEventListener('input', function(e) {
                document.getElementById('thresh_val').textContent = e.target.value + '%';
            });
            
            document.getElementById('moist_threshold').addEventListener('change', function(e) {
                sendCommand('threshold', e.target.value);
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∞—Å–æ—Å–∞
            document.getElementById('pump_switch').addEventListener('change', function(e) {
                sendCommand('pump', e.target.checked ? 'on' : 'off');
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–≤–µ—Ç–∞
            document.getElementById('light_switch').addEventListener('change', function(e) {
                sendCommand('light', e.target.checked ? 'on' : 'off');
            });
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            const settingsInputs = [
                'watering_delay', 'watering_duration', 'manual_pump_time', 
                'manual_light_time', 'lamp_start', 'lamp_end', 
                'sleep_start', 'sleep_end', 'lamp_enabled', 
                'sleep_enabled', 'time_manual'
            ];
            
            settingsInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveDeviceSettings);
                }
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target.id);
                }
            });
        }
        
        function saveDeviceSettings() {
            const settings = {
                moisture_threshold: parseInt(document.getElementById('moist_threshold').value),
                watering_delay: parseInt(document.getElementById('watering_delay').value),
                watering_duration: parseInt(document.getElementById('watering_duration').value),
                manual_pump_time: parseInt(document.getElementById('manual_pump_time').value),
                manual_light_time: parseInt(document.getElementById('manual_light_time').value),
                lamp_start: document.getElementById('lamp_start').value,
                lamp_end: document.getElementById('lamp_end').value,
                lamp_enabled: document.getElementById('lamp_enabled').checked,
                sleep_start: document.getElementById('sleep_start').value,
                sleep_end: document.getElementById('sleep_end').value,
                sleep_enabled: document.getElementById('sleep_enabled').checked,
                time_manual: document.getElementById('time_manual').checked
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            localStorage.setItem('device_settings', JSON.stringify(settings));
            
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ', 'success');
        }
        
        // ===== –ó–ê–ì–†–£–ó–ö–ê –ü–†–ò –ó–ê–ü–£–°–ö–ï =====
        window.onload = function() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            setTimeout(() => {
                showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è EcoGrow!', 'info');
            }, 1000);
            
            // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if (localStorage.getItem('device_id')) {
                setTimeout(testConnection, 2000);
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                setTimeout(() => {
                    openModal('settingsModal');
                }, 3000);
            }
        };
    </script>
</body>
</html>
