<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGrow Remote Control</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-green: #27ae60;
            --accent-blue: #3498db;
            --accent-red: #e74c3c;
            --accent-orange: #f39c12;
            --border-color: #e1e8ed;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }
        
        .status-offline {
            background: var(--accent-red);
        }
        
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        
        .btn-success {
            background: var(--accent-green);
            color: white;
        }
        
        .btn-danger {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-orange {
            background: var(--accent-orange);
            color: white;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .chart-container {
            height: 200px;
            margin: 15px 0;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--accent-green);
            color: white;
            border-radius: 8px;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
        }
        
        .notification.error {
            background: var(--accent-red);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .control-panel {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± EcoGrow Remote Control</h1>
            <div>
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
        </div>
        
        <div class="device-selector">
            <select id="deviceSelect" style="padding: 8px; border-radius: 8px; border: 2px solid var(--border-color); width: 300px;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
            </select>
            <button onclick="loadDevices()" class="btn-primary" id="refreshBtn">
                <span id="refreshText">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</span>
            </button>
            <button onclick="showAddDeviceModal()" class="btn-orange">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
        </div>
        
        <div class="grid" id="dashboard">
            <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ EcoGrow Remote Control!</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
                <p style="margin-top: 20px; color: var(--accent-orange);">
                    üì± –î–æ—Å—Ç—É–ø–Ω–æ –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –º–∏—Ä–∞!
                </p>
                <div style="margin-top: 30px;">
                    <p>–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–Ω–∞—á–∏—Ç Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω!</p>
                    <p>–°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–û–±–Ω–æ–≤–∏—Ç—å"</p>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 20px; grid-column: 1 / -1;">
            <h3>üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:</h3>
            <ol style="margin-top: 10px; padding-left: 20px;">
                <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–æ—à–∏–≤–∫—É –Ω–∞ ESP8266</li>
                <li>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ WiFi —Ç–æ—á–∫–µ "EcoGrow_Setup" (–ø–∞—Ä–æ–ª—å: 12345678)</li>
                <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–∞—à–µ–π WiFi —Å–µ—Ç–∏</li>
                <li>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ Firebase</li>
                <li>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>
            </ol>
            <div style="margin-top: 20px;">
                <h4>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase:</h4>
                <button onclick="testFirebaseConnection()" class="btn-primary">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                <div id="firebaseTestResult" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
    <div id="addDeviceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
            <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h2>
            <div style="margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <label>–ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
                    <input type="text" id="deviceName" value="–¢–µ—Å—Ç–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
                    <input type="text" id="deviceId" value="test_device" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc;">
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="hideAddDeviceModal()" style="padding: 10px 20px; background: #ccc; border: none; border-radius: 5px; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="addTestDevice()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase REST API
        const FIREBASE_HOST = "ecogrow-remote-default-rtdb.firebaseio.com";
        const FIREBASE_AUTH_KEY = "BUZJq4KALKON2yX0HsXZFMz8CPTwA1IYzd2XQnDf";
        const FIREBASE_URL = `https://${FIREBASE_HOST}`;
        
        let currentDevice = null;
        let devices = {};
        let chart = null;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Firebase
        async function firebaseRequest(method, path, data = null) {
            const url = `${FIREBASE_URL}/${path}.json?auth=${FIREBASE_AUTH_KEY}`;
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Firebase request error:', error);
                throw error;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        async function loadDevices() {
            try {
                showLoading('refreshBtn', 'üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...');
                const data = await firebaseRequest('GET', 'devices');
                devices = data || {};
                
                const select = document.getElementById('deviceSelect');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>';
                
                let deviceCount = 0;
                for (const deviceId in devices) {
                    const device = devices[deviceId];
                    if (device && device.info) {
                        const option = document.createElement('option');
                        option.value = deviceId;
                        const deviceName = device.info.device_name || deviceId;
                        const lastSeen = device.info.last_seen ? 
                            formatTime(device.info.last_seen * 1000) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                        option.textContent = `${deviceName} (${deviceId}) - ${lastSeen}`;
                        select.appendChild(option);
                        deviceCount++;
                    }
                }
                
                updateConnectionStatus(true);
                showNotification(`–ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${deviceCount}`, 'success');
                hideLoading('refreshBtn', 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:', error);
                updateConnectionStatus(false);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase', 'error');
                hideLoading('refreshBtn', 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function selectDevice(deviceId) {
            currentDevice = deviceId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('deviceSelect').value = deviceId;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            loadDeviceState(deviceId);
            
            // –ù–∞—á–∏–Ω–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            startDeviceMonitoring(deviceId);
            
            showNotification(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É: ${devices[deviceId]?.info?.device_name || deviceId}`);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        async function loadDeviceState(deviceId) {
            try {
                const state = await firebaseRequest('GET', `devices/${deviceId}/state`);
                if (state) {
                    updateDashboard(state, deviceId);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è dashboard
        function updateDashboard(state, deviceId) {
            const dashboard = document.getElementById('dashboard');
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const lastUpdate = state.last_update ? 
                formatTime(state.last_update * 1000) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const isOnline = state.last_update && (Date.now() / 1000 - state.last_update) < 120;
            
            dashboard.innerHTML = `
                <div class="card">
                    <h2>üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</h2>
                    <div class="stat-value">${state.moisture || 0}%</div>
                    <div style="margin-top: 10px;">
                        <div>–°—Ä–µ–¥–Ω—è—è: ${state.moisture_avg || 0}%</div>
                        <div>–ú–∏–Ω–∏–º—É–º: ${state.moisture_min || 0}%</div>
                        <div>–ú–∞–∫—Å–∏–º—É–º: ${state.moisture_max || 0}%</div>
                        <div style="margin-top: 10px; color: ${isOnline ? 'var(--accent-green)' : 'var(--accent-red)'};">
                            ${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ—Ñ–ª–∞–π–Ω'}
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üö∞ –ù–∞—Å–æ—Å</h2>
                    <div style="font-size: 1.2rem; margin: 10px 0;">
                        –°—Ç–∞—Ç—É—Å: <strong style="color: ${state.pump_on ? 'var(--accent-green)' : 'var(--accent-red)'}">
                        ${state.pump_on ? '‚úÖ –í–ö–õ' : '‚ùå –í–´–ö–õ'}</strong>
                    </div>
                    <div>–†–µ–∂–∏–º: ${state.manual_pump ? '–†—É—á–Ω–æ–π' : '–ê–≤—Ç–æ'}</div>
                    <div>–ü–æ—Ä–æ–≥: ${state.moisture_threshold || 50}%</div>
                    <div>–í—Å–µ–≥–æ –ø–æ–ª–∏–≤–æ–≤: ${state.total_waterings || 0}</div>
                    <div class="control-panel">
                        <button onclick="sendCommand('pump', 'on')" class="btn-success">–í–∫–ª—é—á–∏—Ç—å</button>
                        <button onclick="sendCommand('pump', 'off')" class="btn-danger">–í—ã–∫–ª—é—á–∏—Ç—å</button>
                        <button onclick="sendCommand('pump', 'auto')" class="btn-primary">–ê–≤—Ç–æ</button>
                        <button onclick="sendCommand('pump', 'water')" class="btn-primary">–ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üí° –§–∏—Ç–æ–ª–∞–º–ø–∞</h2>
                    <div style="font-size: 1.2rem; margin: 10px 0;">
                        –°—Ç–∞—Ç—É—Å: <strong style="color: ${state.light_on ? 'var(--accent-green)' : 'var(--accent-red)'}">
                        ${state.light_on ? '‚úÖ –í–ö–õ' : '‚ùå –í–´–ö–õ'}</strong>
                    </div>
                    <div>–†–µ–∂–∏–º: ${state.manual_light ? '–†—É—á–Ω–æ–π' : '–ê–≤—Ç–æ'}</div>
                    <div>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: ${state.lamp_start || '08:00'} - ${state.lamp_end || '20:00'}</div>
                    <div>–í—Å–µ–≥–æ —á–∞—Å–æ–≤: ${state.total_light_hours || 0}</div>
                    <div class="control-panel">
                        <button onclick="sendCommand('light', 'on')" class="btn-success">–í–∫–ª—é—á–∏—Ç—å</button>
                        <button onclick="sendCommand('light', 'off')" class="btn-danger">–í—ã–∫–ª—é—á–∏—Ç—å</button>
                        <button onclick="sendCommand('light', 'auto')" class="btn-primary">–ê–≤—Ç–æ</button>
                    </div>
                </div>
                
                <div class="card" style="grid-column: 1 / -1;">
                    <h2>üìà –ò—Å—Ç–æ—Ä–∏—è –≤–ª–∞–∂–Ω–æ—Å—Ç–∏</h2>
                    <div class="chart-container">
                        <canvas id="moistureChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                    <div>–ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–∏–≤–∞: ${state.watering_delay || 30} –º–∏–Ω</div>
                    <div>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${state.watering_duration || 2} —Å–µ–∫</div>
                    <div>–†–µ–∂–∏–º —Å–Ω–∞: ${state.sleep_enabled ? '‚úÖ –í–∫–ª' : '‚ùå –í—ã–∫–ª'}</div>
                    <div>–°–æ–Ω: ${state.sleep_start || '23:00'} - ${state.sleep_end || '07:00'}</div>
                    <div>–õ–∞–º–ø–∞: ${state.lamp_enabled ? '‚úÖ –í–∫–ª' : '‚ùå –í—ã–∫–ª'}</div>
                    <div style="margin-top: 10px;">
                        <button onclick="showSettingsModal()" class="btn-primary">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                    <div>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${state.device_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
                    <div>–í—Ä–µ–º—è: ${state.current_time || '--:--'}</div>
                    <div>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${lastUpdate}</div>
                    <div>WiFi RSSI: ${state.wifi_rssi || 0} dBm</div>
                    <div>Uptime: ${Math.floor((state.uptime || 0) / 3600)} —á</div>
                    <div style="margin-top: 10px;">
                        <button onclick="sendTestCommand()" class="btn-orange">–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞</button>
                    </div>
                </div>
            `;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            if (state.moisture_history && Array.isArray(state.moisture_history)) {
                updateChart(state.moisture_history);
            }
            
            updateConnectionStatus(true);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã
        async function sendCommand(type, value) {
            if (!currentDevice) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', 'error');
                return;
            }
            
            try {
                const command = {};
                command[type] = value;
                
                await firebaseRequest('PATCH', `devices/${currentDevice}/commands`, command);
                showNotification(`–ö–æ–º–∞–Ω–¥–∞ "${type}: ${value}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    loadDeviceState(currentDevice);
                }, 2000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã', 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã
        async function sendTestCommand() {
            if (!currentDevice) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', 'error');
                return;
            }
            
            try {
                const command = {
                    test: Date.now(),
                    message: "–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"
                };
                
                await firebaseRequest('PATCH', `devices/${currentDevice}/commands`, command);
                showNotification('–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã', 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        function updateChart(historyData) {
            const ctx = document.getElementById('moistureChart');
            if (!ctx) return;
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array(historyData.length).fill(''),
                    datasets: [{
                        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å %',
                        data: historyData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        x: { 
                            display: false,
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function startDeviceMonitoring(deviceId) {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (window.monitoringInterval) {
                clearInterval(window.monitoringInterval);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            window.monitoringInterval = setInterval(() => {
                loadDeviceState(deviceId);
            }, 5000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('statusText');
            
            if (connected) {
                indicator.className = 'status-indicator status-online';
                text.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç Firebase';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.transform = 'translateX(120%)';
            }, 3000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function showLoading(buttonId, text) {
            const button = document.getElementById(buttonId);
            const textSpan = document.getElementById(buttonId + 'Text');
            if (textSpan) {
                textSpan.innerHTML = '<span class="loading"></span> ' + text;
            }
            button.disabled = true;
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function hideLoading(buttonId, text) {
            const button = document.getElementById(buttonId);
            const textSpan = document.getElementById(buttonId + 'Text');
            if (textSpan) {
                textSpan.textContent = text;
            }
            button.disabled = false;
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase
        async function testFirebaseConnection() {
            try {
                showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase...');
                const result = await firebaseRequest('GET', '');
                document.getElementById('firebaseTestResult').innerHTML = 
                    `<div style="color: var(--accent-green);">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!</div>
                     <div style="margin-top: 5px;">Firebase –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞</div>`;
                showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase —É—Å–ø–µ—à–Ω–æ!');
            } catch (error) {
                document.getElementById('firebaseTestResult').innerHTML = 
                    `<div style="color: var(--accent-red);">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                     <div style="margin-top: 5px;">${error.message}</div>`;
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase', 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function showAddDeviceModal() {
            document.getElementById('addDeviceModal').style.display = 'flex';
        }
        
        function hideAddDeviceModal() {
            document.getElementById('addDeviceModal').style.display = 'none';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        async function addTestDevice() {
            const deviceId = document.getElementById('deviceId').value.trim();
            const deviceName = document.getElementById('deviceName').value.trim();
            
            if (!deviceId || !deviceName) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                const deviceData = {
                    info: {
                        device_id: deviceId,
                        device_name: deviceName,
                        ip_address: '192.168.1.100',
                        firmware_version: '4.0',
                        last_seen: Math.floor(Date.now() / 1000)
                    },
                    state: {
                        moisture: Math.floor(Math.random() * 40) + 40,
                        moisture_avg: Math.floor(Math.random() * 10) + 45,
                        moisture_min: 40,
                        moisture_max: 80,
                        pump_on: false,
                        light_on: true,
                        manual_pump: false,
                        manual_light: false,
                        moisture_threshold: 50,
                        watering_delay: 30,
                        watering_duration: 2,
                        total_waterings: Math.floor(Math.random() * 50),
                        total_light_hours: Math.floor(Math.random() * 200),
                        lamp_start: "08:00",
                        lamp_end: "20:00",
                        lamp_enabled: true,
                        sleep_start: "23:00",
                        sleep_end: "07:00",
                        sleep_enabled: false,
                        current_time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        time_manual: false,
                        last_update: Math.floor(Date.now() / 1000),
                        device_name: deviceName,
                        wifi_rssi: -65,
                        uptime: Math.floor(Math.random() * 86400),
                        moisture_history: Array(20).fill(0).map(() => Math.floor(Math.random() * 30) + 40)
                    }
                };
                
                await firebaseRequest('PUT', `devices/${deviceId}`, deviceData);
                showNotification('–¢–µ—Å—Ç–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
                hideAddDeviceModal();
                loadDevices();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', 'error');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            loadDevices();
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            document.getElementById('deviceSelect').addEventListener('change', (e) => {
                if (e.target.value) {
                    selectDevice(e.target.value);
                } else {
                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
                    document.getElementById('dashboard').innerHTML = `
                        <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ EcoGrow Remote Control!</h2>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
                            <p style="margin-top: 20px; color: var(--accent-orange);">
                                üì± –î–æ—Å—Ç—É–ø–Ω–æ –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –º–∏—Ä–∞!
                            </p>
                        </div>
                    `;
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                    if (window.monitoringInterval) {
                        clearInterval(window.monitoringInterval);
                        window.monitoringInterval = null;
                    }
                }
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(loadDevices, 30000);
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(testFirebaseConnection, 1000);
        });
    </script>
</body>
</html>
