<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üå± EcoGrow Web App</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* –ü–æ–ª–Ω—ã–π CSS –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ - –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ —Å—é–¥–∞ */
        /* –°–æ–∫—Ä–∞—â–µ–Ω–Ω–æ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ */
        
        :root {
            --bg-primary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-green: #27ae60;
            --accent-blue: #3498db;
            --accent-red: #e74c3c;
            --accent-orange: #f39c12;
            --accent-purple: #9b59b6;
            --border-color: #e1e8ed;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --gradient-primary: linear-gradient(135deg, #27ae60, #2ecc71);
            --gradient-blue: linear-gradient(135deg, #3498db, #2980b9);
            --gradient-purple: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        /* ... –æ—Å—Ç–∞–ª—å–Ω–æ–π CSS –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ ... */
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <div class="modal" id="connectionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É</h2>
            </div>
            
            <div class="control-group">
                <div class="control-item">
                    <label>ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (Chat ID)</label>
                    <input type="text" id="deviceId" placeholder="6712996693">
                </div>
                
                <div class="control-item">
                    <label>–¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞</label>
                    <input type="password" id="botToken" 
                           placeholder="8365221747:AAEskXtc6T-IhEik718wJJ9x-vz_TOh26tw">
                </div>
                
                <div class="control-item">
                    <label>–õ–æ–∫–∞–ª—å–Ω—ã–π IP –∞–¥—Ä–µ—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" id="localIp" placeholder="192.168.1.100 –∏–ª–∏ ecogrow.local">
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="connectToDevice()" style="width: 100%;">
                        –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 10px;">
                    <h4 style="margin-bottom: 10px;">üí° –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?</h4>
                    <p style="font-size: 0.9rem; color: #666;">
                        1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –±–æ—Ç–∞ @EcoGrow_assis_Bot<br>
                        2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start<br>
                        3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal" id="advancedSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button class="modal-close" onclick="closeModal('advancedSettingsModal')">&times;</button>
            </div>
            
            <div class="control-group">
                <div class="switch-row">
                    <div class="switch-label">
                        <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∏–∑–∫–æ–π –≤–ª–∞–∂–Ω–æ—Å—Ç–∏</span>
                        <span class="subtext">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="notificationsAlert">
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <div class="control-item">
                    <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (%)</label>
                    <input type="number" id="minMoistureAlert" min="5" max="50" step="5" value="20">
                </div>
                
                <div class="control-item">
                    <label>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (%)</label>
                    <input type="number" id="maxMoistureAlert" min="50" max="100" step="5" value="90">
                </div>
                
                <div class="control-item">
                    <label>–ö–¥ –º–µ–∂–¥—É –ø–æ–ª–∏–≤–∞–º–∏ (–º–∏–Ω—É—Ç)</label>
                    <input type="number" id="pumpCooldown" min="1" max="60" step="1" value="5">
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span>–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Ä–µ–∂–∏–º</span>
                        <span class="subtext">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏–≤ –∏ –æ—Å–≤–µ—â–µ–Ω–∏–µ</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="autoMode">
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                        <span class="subtext">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="darkTheme" onchange="toggleTheme()">
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span>–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
                        <span class="subtext">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ Chrome –∏ Edge</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="voiceControl">
                        <span class="slider-switch"></span>
                    </label>
                </div>
                
                <div class="switch-row">
                    <div class="switch-label">
                        <span>Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                        <span class="subtext">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="pushNotifications">
                        <span class="slider-switch"></span>
                    </label>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveAdvancedSettings()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <button class="btn btn-secondary" onclick="resetToDefaults()">
                    –°–±—Ä–æ—Å–∏—Ç—å –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º
                </button>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container" style="display: none;" id="mainContainer">
        <div class="header">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="material-icons">eco</span>
                    EcoGrow Control Panel
                </h1>
                <p class="app-subtitle" id="deviceStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                    <span class="material-icons">dark_mode</span>
                    –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
                </button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ -->
        <div class="grid" id="dashboardGrid">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- FAB –∫–Ω–æ–ø–∫–∏ -->
    <div class="fab-container" style="display: none;" id="fabContainer">
        <button class="fab fab-refresh" onclick="refreshData()" data-tooltip="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
            <span class="material-icons">refresh</span>
        </button>
        <button class="fab fab-theme" onclick="toggleTheme()" data-tooltip="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
            <span class="material-icons" id="themeIcon">dark_mode</span>
        </button>
        <button class="fab fab-settings" onclick="openModal('advancedSettingsModal')" data-tooltip="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
            <span class="material-icons">settings</span>
        </button>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <button class="voice-control" id="voiceControlBtn" data-tooltip="–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" style="display: none;">
        <span class="material-icons">mic</span>
    </button>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const CONFIG = {
            DEFAULT_BOT_TOKEN: "8365221747:AAEskXtc6T-IhEik718wJJ9x-vz_TOh26tw",
            DEFAULT_CHAT_ID: "6712996693",
            POLLING_INTERVAL: 10000,
            CHART_HISTORY_SIZE: 50
        };
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let state = {
            deviceId: null,
            botToken: null,
            localIp: null,
            isConnected: false,
            data: {},
            chart: null,
            pollingInterval: null,
            voiceRecognition: null,
            currentTheme: 'light',
            moistureHistory: [],
            connectionType: 'telegram' // 'local' –∏–ª–∏ 'telegram'
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram Web App
            checkTelegramWebApp();
            
            // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            loadSavedSettings();
            
            // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if (!state.deviceId) {
                setTimeout(() => {
                    openModal('connectionModal');
                }, 500);
            } else {
                // 4. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
                connectToDevice();
            }
            
            // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            initVoiceControl();
            
            // 6. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker –¥–ª—è PWA
            registerServiceWorker();
        }
        
        function checkTelegramWebApp() {
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.expand();
                tg.enableClosingConfirmation();
                
                const initData = tg.initDataUnsafe;
                if (initData.user) {
                    const chatId = initData.user.id.toString();
                    state.deviceId = chatId;
                    document.getElementById('deviceId').value = chatId;
                }
                
                if (tg.initDataUnsafe.start_param) {
                    const deviceId = tg.initDataUnsafe.start_param;
                    state.deviceId = deviceId;
                    document.getElementById('deviceId').value = deviceId;
                }
            }
        }
        
        function loadSavedSettings() {
            state.deviceId = localStorage.getItem('device_id') || CONFIG.DEFAULT_CHAT_ID;
            state.botToken = localStorage.getItem('bot_token') || CONFIG.DEFAULT_BOT_TOKEN;
            state.localIp = localStorage.getItem('local_ip') || '';
            state.currentTheme = localStorage.getItem('theme') || 'light';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const savedSettings = JSON.parse(localStorage.getItem('advanced_settings') || '{}');
            
            document.getElementById('deviceId').value = state.deviceId;
            document.getElementById('botToken').value = state.botToken;
            document.getElementById('localIp').value = state.localIp;
            document.getElementById('darkTheme').checked = state.currentTheme === 'dark';
            document.getElementById('notificationsAlert').checked = savedSettings.notificationsAlert !== false;
            document.getElementById('minMoistureAlert').value = savedSettings.minMoistureAlert || 20;
            document.getElementById('maxMoistureAlert').value = savedSettings.maxMoistureAlert || 90;
            document.getElementById('pumpCooldown').value = savedSettings.pumpCooldown || 5;
            document.getElementById('autoMode').checked = savedSettings.autoMode !== false;
            document.getElementById('voiceControl').checked = savedSettings.voiceControl || false;
            document.getElementById('pushNotifications').checked = savedSettings.pushNotifications || false;
            
            setTheme(state.currentTheme);
        }
        
        async function connectToDevice() {
            const deviceId = document.getElementById('deviceId').value.trim();
            const botToken = document.getElementById('botToken').value.trim();
            const localIp = document.getElementById('localIp').value.trim();
            
            if (!deviceId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', 'error');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            state.deviceId = deviceId;
            state.botToken = botToken;
            state.localIp = localIp;
            
            localStorage.setItem('device_id', deviceId);
            localStorage.setItem('bot_token', botToken);
            localStorage.setItem('local_ip', localIp);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeModal('connectionModal');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('fabContainer').style.display = 'flex';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            document.getElementById('deviceStatus').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É...';
            
            // –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                if (localIp) {
                    try {
                        const response = await fetch(`http://${localIp}/webapp/data`, { timeout: 3000 });
                        if (response.ok) {
                            const data = await response.json();
                            state.connectionType = 'local';
                            state.isConnected = true;
                            updateDashboard(data);
                            showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ', 'success');
                            startPolling();
                            return;
                        }
                    } catch (e) {
                        console.log('–õ–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:', e);
                    }
                }
                
                // –ü—Ä–æ–±—É–µ–º Telegram
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: deviceId,
                        text: "/webapp_data",
                        parse_mode: "HTML"
                    })
                });
                
                const telegramData = await response.json();
                
                if (telegramData.ok && telegramData.result.text && telegramData.result.text.startsWith('DATA:')) {
                    const data = JSON.parse(telegramData.result.text.substring(5));
                    state.connectionType = 'telegram';
                    state.isConnected = true;
                    updateDashboard(data);
                    showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ —á–µ—Ä–µ–∑ Telegram', 'success');
                    startPolling();
                } else {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                state.isConnected = false;
                document.getElementById('deviceStatus').textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É', 'error');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–Ω–æ–≤–∞
                setTimeout(() => {
                    openModal('connectionModal');
                }, 2000);
            }
        }
        
        function startPolling() {
            if (state.pollingInterval) {
                clearInterval(state.pollingInterval);
            }
            
            state.pollingInterval = setInterval(() => {
                fetchDeviceData();
            }, CONFIG.POLLING_INTERVAL);
        }
        
        async function fetchDeviceData() {
            if (!state.isConnected) return;
            
            try {
                let data = null;
                
                if (state.connectionType === 'local' && state.localIp) {
                    const response = await fetch(`http://${state.localIp}/webapp/data`, { timeout: 5000 });
                    if (response.ok) {
                        data = await response.json();
                    }
                } else {
                    const url = `https://api.telegram.org/bot${state.botToken}/sendMessage`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: state.deviceId,
                            text: "/webapp_data",
                            parse_mode: "HTML"
                        })
                    });
                    
                    const telegramData = await response.json();
                    if (telegramData.ok && telegramData.result.text && telegramData.result.text.startsWith('DATA:')) {
                        data = JSON.parse(telegramData.result.text.substring(5));
                    }
                }
                
                if (data) {
                    updateDashboard(data);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                state.isConnected = false;
                document.getElementById('deviceStatus').textContent = '–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ';
            }
        }
        
        function updateDashboard(data) {
            state.data = data;
            state.isConnected = true;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            document.getElementById('deviceStatus').textContent = 
                `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ (${state.connectionType === 'local' ? '–õ–æ–∫–∞–ª—å–Ω–æ' : 'Telegram'}) | –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${data.moisture || 0}%`;
            
            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
            updateDashboardCards(data);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
            if (data.moisture !== undefined) {
                state.moistureHistory.push({
                    time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                    value: data.moisture
                });
                
                if (state.moistureHistory.length > CONFIG.CHART_HISTORY_SIZE) {
                    state.moistureHistory.shift();
                }
                
                updateChart();
            }
        }
        
        function updateDashboardCards(data) {
            const grid = document.getElementById('dashboardGrid');
            
            // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            const cards = [
                {
                    id: 'moistureCard',
                    title: 'üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã',
                    value: `${data.moisture || 0}%`,
                    status: getMoistureStatus(data.moisture),
                    type: 'gauge',
                    min: 0,
                    max: 100,
                    current: data.moisture || 0,
                    threshold: data.moisture_threshold || 50
                },
                {
                    id: 'pumpCard',
                    title: 'üö∞ –ù–∞—Å–æ—Å –ø–æ–ª–∏–≤–∞',
                    value: data.pump ? '–í–ö–õ' : '–í–´–ö–õ',
                    status: data.pump ? 'on' : 'off',
                    type: 'control',
                    controls: [
                        { text: '–í–∫–ª—é—á–∏—Ç—å', action: () => sendCommand('pump', 'on'), class: 'btn-success' },
                        { text: '–í—ã–∫–ª—é—á–∏—Ç—å', action: () => sendCommand('pump', 'off'), class: 'btn-danger' },
                        { text: '–ê–≤—Ç–æ—Ä–µ–∂–∏–º', action: () => sendCommand('pump_auto', ''), class: 'btn-secondary' }
                    ],
                    settings: [
                        { label: '–í—Ä–µ–º—è —Ä—É—á–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è (—Å–µ–∫)', id: 'pumpTime', type: 'number', value: data.manual_pump_time || 10, min: 5, max: 300 }
                    ]
                },
                {
                    id: 'lightCard',
                    title: 'üí° –§–∏—Ç–æ–ª–∞–º–ø–∞',
                    value: data.light ? '–í–ö–õ' : '–í–´–ö–õ',
                    status: data.light ? 'on' : 'off',
                    type: 'control',
                    controls: [
                        { text: '–í–∫–ª—é—á–∏—Ç—å', action: () => sendCommand('light', 'on'), class: 'btn-success' },
                        { text: '–í—ã–∫–ª—é—á–∏—Ç—å', action: () => sendCommand('light', 'off'), class: 'btn-danger' },
                        { text: '–ê–≤—Ç–æ—Ä–µ–∂–∏–º', action: () => sendCommand('light_auto', ''), class: 'btn-secondary' }
                    ],
                    settings: [
                        { label: '–í—Ä–µ–º—è —Ä—É—á–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è (—á–∞—Å)', id: 'lightTime', type: 'number', value: data.manual_light_time || 1, min: 1, max: 24 }
                    ]
                },
                {
                    id: 'thresholdCard',
                    title: 'üéØ –ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏',
                    value: `${data.moisture_threshold || 50}%`,
                    type: 'slider',
                    min: 10,
                    max: 90,
                    value: data.moisture_threshold || 50,
                    action: (value) => sendCommand('threshold', value)
                }
            ];
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const statsCard = {
                id: 'statsCard',
                title: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                type: 'stats',
                stats: [
                    { label: '–í—Å–µ–≥–æ –ø–æ–ª–∏–≤–æ–≤', value: data.total_waterings || 0 },
                    { label: '–ß–∞—Å–æ–≤ —Å–≤–µ—Ç–∞', value: data.total_light_hours || 0 },
                    { label: '–°—Ä–µ–¥–Ω—è—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å', value: data.avg_moisture ? `${data.avg_moisture}%` : '--%' },
                    { label: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å', value: data.min_moisture ? `${data.min_moisture}%` : '--%' }
                ]
            };
            
            // –û—à–∏–±–∫–∏
            const errorsCard = {
                id: 'errorsCard',
                title: '‚ö†Ô∏è –û—à–∏–±–∫–∏ —Å–∏—Å—Ç–µ–º—ã',
                type: 'errors',
                errors: data.errors || [],
                controls: [
                    { text: '–û—á–∏—Å—Ç–∏—Ç—å –æ—à–∏–±–∫–∏', action: () => sendCommand('clear_errors', ''), class: 'btn-danger' },
                    { text: '–û–±–Ω–æ–≤–∏—Ç—å', action: fetchDeviceData, class: 'btn-secondary' }
                ]
            };
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            const allCards = [...cards, statsCard, errorsCard];
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
            let html = '';
            allCards.forEach(card => {
                html += generateCardHTML(card);
            });
            
            grid.innerHTML = html;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫
            initChart();
        }
        
        function generateCardHTML(card) {
            let html = `<div class="card" id="${card.id}">`;
            html += `<div class="card-header"><div class="card-title">${card.title}</div>`;
            
            if (card.status) {
                html += `<div class="status-badge ${card.status === 'on' ? 'status-on' : card.status === 'off' ? 'status-off' : card.status}">${card.value}</div>`;
            } else {
                html += `<div class="status-badge">${card.value}</div>`;
            }
            
            html += `</div>`;
            
            if (card.type === 'gauge') {
                html += `
                    <div class="progress-bar" style="height: 20px; background: #eee; border-radius: 10px; overflow: hidden; margin: 20px 0;">
                        <div style="height: 100%; background: ${getMoistureColor(card.current)}; width: ${card.current}%; transition: width 0.5s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>0%</span>
                        <span>–ü–æ—Ä–æ–≥: ${card.threshold}%</span>
                        <span>100%</span>
                    </div>
                `;
            }
            
            if (card.type === 'control' && card.controls) {
                html += `<div class="btn-group">`;
                card.controls.forEach(control => {
                    html += `<button class="btn ${control.class}" onclick="${control.action.toString().replace(/"/g, '&quot;')}">${control.text}</button>`;
                });
                html += `</div>`;
                
                if (card.settings) {
                    html += `<div class="control-group" style="margin-top: 20px;">`;
                    card.settings.forEach(setting => {
                        html += `
                            <div class="control-item">
                                <label>${setting.label}</label>
                                <input type="${setting.type}" id="${setting.id}" 
                                       value="${setting.value}" min="${setting.min}" max="${setting.max}">
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
            }
            
            if (card.type === 'slider') {
                html += `
                    <div class="slider-container" style="margin: 20px 0;">
                        <input type="range" min="${card.min}" max="${card.max}" value="${card.value}" 
                               oninput="document.getElementById('${card.id}_value').textContent = this.value + '%'"
                               onchange="${card.action.toString().replace(/"/g, '&quot;').replace('value', 'this.value')}">
                        <div class="slider-value" id="${card.id}_value">${card.value}%</div>
                    </div>
                `;
            }
            
            if (card.type === 'stats' && card.stats) {
                html += `<div class="stats-grid">`;
                card.stats.forEach(stat => {
                    html += `
                        <div class="stat-card">
                            <div class="stat-value">${stat.value}</div>
                            <div class="stat-label">${stat.label}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            if (card.type === 'errors' && card.errors) {
                if (card.errors.length > 0) {
                    html += `<div class="errors-list">`;
                    card.errors.slice(0, 3).forEach(error => {
                        html += `
                            <div class="error-item">
                                <div class="error-time">üïê ${error.time}</div>
                                <div class="error-msg">${error.msg}</div>
                            </div>
                        `;
                    });
                    if (card.errors.length > 3) {
                        html += `<div style="text-align: center; margin-top: 10px; color: #666;">
                                 –ò –µ—â–µ ${card.errors.length - 3} –æ—à–∏–±–æ–∫...
                                 </div>`;
                    }
                    html += `</div>`;
                } else {
                    html += `<div style="text-align: center; padding: 30px; color: #666;">‚úÖ –û—à–∏–±–æ–∫ –Ω–µ—Ç</div>`;
                }
                
                if (card.controls) {
                    html += `<div class="btn-group" style="margin-top: 20px;">`;
                    card.controls.forEach(control => {
                        html += `<button class="btn ${control.class}" onclick="${control.action.toString().replace(/"/g, '&quot;')}">${control.text}</button>`;
                    });
                    html += `</div>`;
                }
            }
            
            html += `</div>`;
            return html;
        }
        
        function getMoistureStatus(moisture) {
            if (moisture < 30) return 'status-error';
            if (moisture < 50) return 'status-off';
            return 'status-on';
        }
        
        function getMoistureColor(moisture) {
            if (moisture < 30) return '#e74c3c';
            if (moisture < 50) return '#f39c12';
            return '#27ae60';
        }
        
        function initChart() {
            const ctx = document.createElement('canvas');
            ctx.id = 'moistureChart';
            ctx.style.width = '100%';
            ctx.style.height = '250px';
            
            const chartContainer = document.getElementById('chartContainer');
            if (chartContainer) {
                chartContainer.innerHTML = '';
                chartContainer.appendChild(ctx);
            } else {
                const card = document.createElement('div');
                card.className = 'card wide-card';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">üìà –ì—Ä–∞—Ñ–∏–∫ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏</div>
                    </div>
                    <div id="chartContainer"></div>
                `;
                document.getElementById('dashboardGrid').prepend(card);
                document.getElementById('chartContainer').appendChild(ctx);
            }
            
            if (state.chart) {
                state.chart.destroy();
            }
            
            state.chart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: state.moistureHistory.map(item => item.time),
                    datasets: [{
                        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å %',
                        data: state.moistureHistory.map(item => item.value),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function updateChart() {
            if (!state.chart) return;
            
            state.chart.data.labels = state.moistureHistory.map(item => item.time);
            state.chart.data.datasets[0].data = state.moistureHistory.map(item => item.value);
            state.chart.update('none');
        }
        
        async function sendCommand(cmd, value) {
            if (!state.isConnected) {
                showNotification('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É', 'error');
                return;
            }
            
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è WebApp
                const commandText = `WEBAPP:${cmd}=${value}`;
                
                if (state.connectionType === 'local' && state.localIp) {
                    // –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
                    const response = await fetch(`http://${state.localIp}/webapp/command`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cmd: cmd,
                            device_id: state.deviceId,
                            param: value
                        })
                    });
                    
                    const data = await response.json();
                    if (data.status === 'ok') {
                        showNotification('–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', 'success');
                        setTimeout(fetchDeviceData, 2000);
                    }
                } else {
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram
                    const url = `https://api.telegram.org/bot${state.botToken}/sendMessage`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: state.deviceId,
                            text: commandText,
                            parse_mode: "HTML"
                        })
                    });
                    
                    const data = await response.json();
                    if (data.ok) {
                        showNotification('–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', 'success');
                        setTimeout(fetchDeviceData, 2000);
                    } else {
                        throw new Error(data.description || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã', 'error');
            }
        }
        
        function initVoiceControl() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                state.voiceRecognition = new SpeechRecognition();
                state.voiceRecognition.lang = 'ru-RU';
                state.voiceRecognition.continuous = false;
                state.voiceRecognition.interimResults = false;
                
                state.voiceRecognition.onstart = function() {
                    document.getElementById('voiceControlBtn').classList.add('listening');
                    showNotification('–°–ª—É—à–∞—é...', 'info');
                };
                
                state.voiceRecognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    processVoiceCommand(transcript);
                };
                
                state.voiceRecognition.onerror = function(event) {
                    console.error('Voice recognition error', event.error);
                    document.getElementById('voiceControlBtn').classList.remove('listening');
                    showNotification('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞', 'error');
                };
                
                state.voiceRecognition.onend = function() {
                    document.getElementById('voiceControlBtn').classList.remove('listening');
                };
                
                const voiceBtn = document.getElementById('voiceControlBtn');
                if (voiceBtn) {
                    voiceBtn.addEventListener('click', function() {
                        if (localStorage.getItem('voice_enabled') === 'true') {
                            state.voiceRecognition.start();
                        } else {
                            showNotification('–í–∫–ª—é—á–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'warning');
                        }
                    });
                }
            } else {
                const voiceBtn = document.getElementById('voiceControlBtn');
                if (voiceBtn) voiceBtn.style.display = 'none';
            }
        }
        
        function processVoiceCommand(command) {
            console.log('Voice command:', command);
            
            if (command.includes('–≤–∫–ª—é—á–∏ –Ω–∞—Å–æ—Å') || command.includes('–ø–æ–ª–∏–≤')) {
                sendCommand('pump', 'on');
                showNotification('–ù–∞—Å–æ—Å –≤–∫–ª—é—á—ë–Ω', 'success');
            } else if (command.includes('–≤—ã–∫–ª—é—á–∏ –Ω–∞—Å–æ—Å') || command.includes('—Å—Ç–æ–ø –ø–æ–ª–∏–≤')) {
                sendCommand('pump', 'off');
                showNotification('–ù–∞—Å–æ—Å –≤—ã–∫–ª—é—á–µ–Ω', 'success');
            } else if (command.includes('–≤–∫–ª—é—á–∏ —Å–≤–µ—Ç') || command.includes('–ª–∞–º–ø–∞')) {
                sendCommand('light', 'on');
                showNotification('–°–≤–µ—Ç –≤–∫–ª—é—á—ë–Ω', 'success');
            } else if (command.includes('–≤—ã–∫–ª—é—á–∏ —Å–≤–µ—Ç')) {
                sendCommand('light', 'off');
                showNotification('–°–≤–µ—Ç –≤—ã–∫–ª—é—á–µ–Ω', 'success');
            } else if (command.includes('–∞–≤—Ç–æ —Ä–µ–∂–∏–º')) {
                sendCommand('pump_auto', '');
                showNotification('–í–∫–ª—é—á—ë–Ω –∞–≤—Ç–æ—Ä–µ–∂–∏–º', 'success');
            } else if (command.includes('—Å—Ç–∞—Ç—É—Å') || command.includes('–∫–∞–∫ –¥–µ–ª–∞')) {
                fetchDeviceData();
                showNotification('–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å...', 'info');
            } else {
                showNotification('–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞: ' + command, 'warning');
            }
        }
        
        function setTheme(theme) {
            state.currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeIcon = document.getElementById('themeIcon');
            const themeToggle = document.getElementById('themeToggle');
            
            if (theme === 'dark') {
                themeIcon.textContent = 'light_mode';
                if (themeToggle) {
                    themeToggle.innerHTML = '<span class="material-icons">light_mode</span> –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
                }
            } else {
                themeIcon.textContent = 'dark_mode';
                if (themeToggle) {
                    themeToggle.innerHTML = '<span class="material-icons">dark_mode</span> –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
                }
            }
        }
        
        function toggleTheme() {
            const newTheme = state.currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
            showNotification('–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ' + (newTheme === 'dark' ? '—Ç—ë–º–Ω—É—é' : '—Å–≤–µ—Ç–ª—É—é'), 'info');
        }
        
        function saveAdvancedSettings() {
            const settings = {
                notificationsAlert: document.getElementById('notificationsAlert').checked,
                minMoistureAlert: parseInt(document.getElementById('minMoistureAlert').value),
                maxMoistureAlert: parseInt(document.getElementById('maxMoistureAlert').value),
                pumpCooldown: parseInt(document.getElementById('pumpCooldown').value),
                autoMode: document.getElementById('autoMode').checked,
                voiceControl: document.getElementById('voiceControl').checked,
                pushNotifications: document.getElementById('pushNotifications').checked,
                darkTheme: document.getElementById('darkTheme').checked
            };
            
            localStorage.setItem('advanced_settings', JSON.stringify(settings));
            localStorage.setItem('voice_enabled', settings.voiceControl);
            localStorage.setItem('notifications_enabled', settings.pushNotifications);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const voiceBtn = document.getElementById('voiceControlBtn');
            if (voiceBtn) {
                voiceBtn.style.display = settings.voiceControl ? 'block' : 'none';
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            sendCommand('settings', JSON.stringify(settings));
            
            closeModal('advancedSettingsModal');
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        }
        
        function resetToDefaults() {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', error);
                    });
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            setTimeout(() => {
                document.getElementById(modalId).style.opacity = '1';
            }, 10);
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        function showNotification(message, type = 'info') {
            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="material-icons">${getNotificationIcon(type)}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(120%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check_circle';
                case 'error': return 'error';
                case 'warning': return 'warning';
                default: return 'info';
            }
        }
        
        function refreshData() {
            fetchDeviceData();
            showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HTML
        window.connectToDevice = connectToDevice;
        window.toggleTheme = toggleTheme;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.refreshData = refreshData;
        window.saveAdvancedSettings = saveAdvancedSettings;
        window.resetToDefaults = resetToDefaults;
        window.sendCommand = sendCommand;
    </script>
</body>
</html>
