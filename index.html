<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± EcoGrow Control</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* === –í–ï–°–¨ –î–ò–ó–ê–ô–ù –ò–ó –í–ê–®–ï–ì–û –õ–û–ö–ê–õ–¨–ù–û–ì–û –°–ê–ô–¢–ê === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .device-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .devices-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .device-card {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .device-card:hover {
            transform: translateY(-5px);
            border-color: #27ae60;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .device-card.selected {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.05);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f2f6;
        }
        
        .device-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .device-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-online {
            background: rgba(39, 174, 96, 0.15);
            color: #27ae60;
        }
        
        .status-offline {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }
        
        .device-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .info-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        
        .btn-secondary {
            background: #f1f2f6;
            color: #2c3e50;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e8ed;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f2f6;
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .chart-container {
            height: 200px;
            margin: 15px 0;
            position: relative;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 3px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .setting-item {
            margin-bottom: 15px;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #3498db;
        }
        
        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e1e8ed;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            border-left: 5px solid #27ae60;
            max-width: 300px;
            font-weight: 500;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            border-left-color: #e74c3c;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .devices-list {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–ê–ü–ö–ê -->
        <div class="header">
            <h1>üå± EcoGrow Remote Control</h1>
            <p id="connectionStatus">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞–∫—É...</p>
        </div>
        
        <!-- –í–´–ë–û–† –£–°–¢–†–û–ô–°–¢–í–ê -->
        <div class="device-panel" id="deviceSelection">
            <h2>üì± –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h2>
            <p id="devicesCount">–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤...</p>
            <div id="devicesList" class="devices-list">
                <!-- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>
        
        <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
        <div id="mainInterface" style="display: none;">
            <!-- –ì–†–ê–§–ò–ö –í–õ–ê–ñ–ù–û–°–¢–ò -->
            <div class="control-panel">
                <div class="card-header">
                    <div class="card-title">üìà –ì—Ä–∞—Ñ–∏–∫ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏</div>
                    <div id="moist_status" class="device-status status-online">--%</div>
                </div>
                <div class="chart-container">
                    <canvas id="moist_chart"></canvas>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div id="current_moist" class="stat-value">--%</div>
                        <div class="stat-label">–¢–µ–∫—É—â–∞—è</div>
                    </div>
                    <div class="stat-card">
                        <div id="avg_moist" class="stat-value">--%</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω—è—è</div>
                    </div>
                    <div class="stat-card">
                        <div id="min_moist" class="stat-value">--%</div>
                        <div class="stat-label">–ú–∏–Ω–∏–º—É–º</div>
                    </div>
                </div>
            </div>
            
            <div class="grid">
                <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–°–û–°–û–ú -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üíß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–º</div>
                        <div id="pump_status" class="device-status status-offline">–í–´–ö–õ</div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">–ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏: <span id="thresh_val" class="slider-value">50%</span></label>
                        <div class="slider-container">
                            <input id="moist_threshold" type="range" min="10" max="90" value="50">
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞ (—Å–µ–∫—É–Ω–¥—ã)</label>
                        <input id="watering_duration" type="number" min="1" max="300" value="10">
                    </div>
                    
                    <div class="controls" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="togglePump(true)">
                            üíß –í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å
                        </button>
                        <button class="btn btn-danger" onclick="togglePump(false)">
                            ‚õî –í—ã–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å
                        </button>
                    </div>
                    
                    <div class="controls" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="manualWatering()">
                            üöø –ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å
                        </button>
                        <button class="btn btn-secondary" onclick="setPumpAuto()">
                            ‚öôÔ∏è –ê–≤—Ç–æ—Ä–µ–∂–∏–º
                        </button>
                    </div>
                </div>
                
                <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–í–ï–¢–û–ú -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üí° –§–∏—Ç–æ–ª–∞–º–ø–∞</div>
                        <div id="light_status" class="device-status status-offline">–í–´–ö–õ</div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (—á–∞—Å—ã)</label>
                        <input id="light_duration" type="number" min="1" max="24" value="12">
                    </div>
                    
                    <div class="controls" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="toggleLight(true)">
                            üí° –í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç
                        </button>
                        <button class="btn btn-danger" onclick="toggleLight(false)">
                            üåô –í—ã–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç
                        </button>
                    </div>
                    
                    <div class="controls" style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="setLightAuto()">
                            ‚öôÔ∏è –ê–≤—Ç–æ—Ä–µ–∂–∏–º
                        </button>
                    </div>
                </div>
                
                <!-- –£–°–¢–ê–ù–û–í–ö–ê –í–†–ï–ú–ï–ù–ò -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚è∞ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏</div>
                        <div id="time_status" class="device-status">--:--</div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input id="time_hours" type="number" min="0" max="23" value="12" placeholder="–ß–∞—Å—ã">
                            <input id="time_minutes" type="number" min="0" max="59" value="0" placeholder="–ú–∏–Ω—É—Ç—ã">
                        </div>
                    </div>
                    
                    <div class="controls" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="setCurrentTime()">
                            üïê –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å
                        </button>
                        <button class="btn btn-success" onclick="setCustomTime()">
                            ‚è∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
        <div id="notification" class="notification"></div>
    </div>

    <script>
        // ============================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–ê–®–ò –î–ê–ù–ù–´–ï)
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBJSFgQqIrsXj88Xq9h_vwzWjsbZq3z7r8",
            authDomain: "ecogrow-remote.firebaseapp.com",
            databaseURL: "https://ecogrow-remote-default-rtdb.firebaseio.com",
            projectId: "ecogrow-remote",
            storageBucket: "ecogrow-remote.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentDeviceId = null;
        let currentDeviceRef = null;
        let moistureChart = null;
        let moistureHistory = [];
        
        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================
        window.onload = function() {
            initChart();
            loadDevices();
            showNotification('üåê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...');
        };
        
        // ============================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–°–¢–†–û–ô–°–¢–í–ê–ú–ò
        // ============================================
        
        function loadDevices() {
            const devicesRef = database.ref('devices');
            
            devicesRef.on('value', (snapshot) => {
                const devices = snapshot.val();
                const devicesList = document.getElementById('devicesList');
                const devicesCount = document.getElementById('devicesCount');
                const connectionStatus = document.getElementById('connectionStatus');
                
                if (!devices) {
                    devicesList.innerHTML = '<div style="text-align: center; padding: 30px; color: #7f8c8d;">–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    devicesCount.textContent = '–£—Å—Ç—Ä–æ–π—Å—Ç–≤: 0';
                    connectionStatus.innerHTML = 'üî¥ –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤';
                    return;
                }
                
                let html = '';
                let onlineCount = 0;
                
                for (const deviceId in devices) {
                    const device = devices[deviceId];
                    const isOnline = isDeviceOnline(device);
                    if (isOnline) onlineCount++;
                    
                    const isSelected = deviceId === currentDeviceId;
                    
                    html += `
                        <div class="device-card ${isSelected ? 'selected' : ''}" onclick="selectDevice('${deviceId}')">
                            <div class="device-header">
                                <div class="device-name">${device.name || '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ' + deviceId}</div>
                                <div class="device-status ${isOnline ? 'status-online' : 'status-offline'}">
                                    ${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ—Ñ–ª–∞–π–Ω'}
                                </div>
                            </div>
                            <div class="device-info">
                                <div class="info-item">
                                    <div class="info-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
                                    <div class="info-value">${device.data?.moisture || '--'}%</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">–ù–∞—Å–æ—Å</div>
                                    <div class="info-value">${device.data?.pump ? '–í–ö–õ' : '–í–´–ö–õ'}</div>
                                </div>
                            </div>
                            <div class="device-info">
                                <div class="info-item">
                                    <div class="info-label">–°–≤–µ—Ç</div>
                                    <div class="info-value">${device.data?.light ? '–í–ö–õ' : '–í–´–ö–õ'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">IP</div>
                                    <div class="info-value" style="font-size: 0.9rem;">${device.ip || '--'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                devicesList.innerHTML = html;
                devicesCount.textContent = `–£—Å—Ç—Ä–æ–π—Å—Ç–≤: ${Object.keys(devices).length} (${onlineCount} –æ–Ω–ª–∞–π–Ω)`;
                connectionStatus.innerHTML = onlineCount > 0 ? 
                    '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –æ–±–ª–∞–∫—É' : '‚ö†Ô∏è –ù–µ—Ç –æ–Ω–ª–∞–π–Ω-—É—Å—Ç—Ä–æ–π—Å—Ç–≤';
                
                // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ –æ–Ω–ª–∞–π–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                if (!currentDeviceId && onlineCount > 0) {
                    for (const deviceId in devices) {
                        if (isDeviceOnline(devices[deviceId])) {
                            selectDevice(deviceId);
                            break;
                        }
                    }
                }
            });
        }
        
        function isDeviceOnline(device) {
            if (!device.data || !device.data.timestamp) return false;
            const now = Math.floor(Date.now() / 1000);
            const deviceTime = device.data.timestamp;
            return (now - deviceTime) < 120; // 2 –º–∏–Ω—É—Ç—ã
        }
        
        function selectDevice(deviceId) {
            if (currentDeviceRef) {
                currentDeviceRef.off(); // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
            }
            
            currentDeviceId = deviceId;
            currentDeviceRef = database.ref('devices/' + deviceId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            loadDevices();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('mainInterface').style.display = 'block';
            document.getElementById('deviceSelection').style.display = 'none';
            
            // –°–ª—É—à–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            currentDeviceRef.on('value', (snapshot) => {
                const device = snapshot.val();
                if (!device) return;
                
                updateInterface(device);
                updateChartData(device);
            });
            
            showNotification(`‚úÖ –í—ã–±—Ä–∞–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${deviceId}`);
        }
        
        // ============================================
        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // ============================================
        
        function updateInterface(device) {
            const moisture = device.data?.moisture || 0;
            const pumpState = device.data?.pump || false;
            const lightState = device.data?.light || false;
            
            // –í–ª–∞–∂–Ω–æ—Å—Ç—å
            document.getElementById('moist_status').textContent = moisture + '%';
            document.getElementById('current_moist').textContent = moisture + '%';
            
            // –ù–∞—Å–æ—Å
            document.getElementById('pump_status').textContent = pumpState ? '–í–ö–õ' : '–í–´–ö–õ';
            document.getElementById('pump_status').className = 'device-status ' + (pumpState ? 'status-online' : 'status-offline');
            
            // –°–≤–µ—Ç
            document.getElementById('light_status').textContent = lightState ? '–í–ö–õ' : '–í–´–ö–õ';
            document.getElementById('light_status').className = 'device-status ' + (lightState ? 'status-online' : 'status-offline');
            
            // –í—Ä–µ–º—è
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
            document.getElementById('time_status').textContent = timeStr;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            if (device.settings) {
                document.getElementById('moist_threshold').value = device.settings.moistureThreshold || 50;
                document.getElementById('thresh_val').textContent = (device.settings.moistureThreshold || 50) + '%';
                document.getElementById('watering_duration').value = device.settings.pumpDuration || 10;
            }
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            updateStats();
        }
        
        function updateStats() {
            if (moistureHistory.length > 0) {
                const sum = moistureHistory.reduce((a, b) => a + b, 0);
                const avg = Math.round(sum / moistureHistory.length);
                const min = Math.min(...moistureHistory);
                
                document.getElementById('avg_moist').textContent = avg + '%';
                document.getElementById('min_moist').textContent = min + '%';
            }
        }
        
        function updateChartData(device) {
            const moisture = device.data?.moisture;
            if (moisture === undefined) return;
            
            moistureHistory.push(moisture);
            if (moistureHistory.length > 50) {
                moistureHistory.shift();
            }
            
            if (moistureChart) {
                moistureChart.data.datasets[0].data = moistureHistory;
                moistureChart.update('none');
            }
        }
        
        // ============================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–°–¢–†–û–ô–°–¢–í–û–ú
        // ============================================
        
        function sendCommand(command, value) {
            if (!currentDeviceId) {
                showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', true);
                return;
            }
            
            database.ref('devices/' + currentDeviceId + '/commands/latest').set({
                command: command,
                value: value,
                timestamp: Date.now(),
                source: 'web'
            });
        }
        
        function togglePump(state) {
            sendCommand('pump', state ? 1 : 0);
            showNotification(state ? 'üíß –ù–∞—Å–æ—Å –≤–∫–ª—é—á–µ–Ω' : '‚õî –ù–∞—Å–æ—Å –≤—ã–∫–ª—é—á–µ–Ω');
        }
        
        function toggleLight(state) {
            sendCommand('light', state ? 1 : 0);
            showNotification(state ? 'üí° –°–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω' : 'üåô –°–≤–µ—Ç –≤—ã–∫–ª—é—á–µ–Ω');
        }
        
        function manualWatering() {
            sendCommand('pump', 1);
            showNotification('üíß –ó–∞–ø—É—â–µ–Ω —Ä—É—á–Ω–æ–π –ø–æ–ª–∏–≤');
            
            // –ê–≤—Ç–æ–≤—ã–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            const duration = parseInt(document.getElementById('watering_duration').value) * 1000;
            setTimeout(() => {
                sendCommand('pump', 0);
                showNotification('‚úÖ –†—É—á–Ω–æ–π –ø–æ–ª–∏–≤ –∑–∞–≤–µ—Ä—à–µ–Ω');
            }, duration);
        }
        
        function setPumpAuto() {
            sendCommand('pumpAuto', 1);
            showNotification('üîÑ –ù–∞—Å–æ—Å: –∞–≤—Ç–æ—Ä–µ–∂–∏–º');
        }
        
        function setLightAuto() {
            sendCommand('lightAuto', 1);
            showNotification('üîÑ –°–≤–µ—Ç: –∞–≤—Ç–æ—Ä–µ–∂–∏–º');
        }
        
        function setCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            sendCommand('setTime', { hour: hours, minute: minutes });
            showNotification(`üïê –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
        }
        
        function setCustomTime() {
            const hours = parseInt(document.getElementById('time_hours').value);
            const minutes = parseInt(document.getElementById('time_minutes').value);
            
            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                showNotification('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è', true);
                return;
            }
            
            sendCommand('setTime', { hour: hours, minute: minutes });
            showNotification(`üïê –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
        }
        
        // ============================================
        // –ì–†–ê–§–ò–ö–ò
        // ============================================
        
        function initChart() {
            const ctx = document.getElementById('moist_chart').getContext('2d');
            moistureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å %',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { display: false }
                    }
                }
            });
        }
        
        // ============================================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ============================================
        
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (currentDeviceId) {
                database.ref('devices/' + currentDeviceId + '/data/timestamp').once('value').then(snapshot => {
                    const timestamp = snapshot.val();
                    if (timestamp) {
                        const now = Math.floor(Date.now() / 1000);
                        const isOnline = (now - timestamp) < 120;
                        
                        if (!isOnline) {
                            showNotification('‚ö†Ô∏è –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≤ —Å–µ—Ç–∏', true);
                        }
                    }
                });
            }
        }, 5000);
    </script>
</body>
</html>
