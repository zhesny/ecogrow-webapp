<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- –§–ò–ù–ê–õ–¨–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø CSP –î–õ–Ø FIREBASE -->
    <meta http-equiv="Content-Security-Policy" 
          content="
              default-src 'self' blob: data:;
              script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.gstatic.com https://cdn.jsdelivr.net https://ecogrow-remote-default-rtdb.firebaseio.com;
              style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
              connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://*.googleapis.com https://cdn.jsdelivr.net https://www.gstatic.com;
              img-src 'self' data: blob: https:;
              font-src 'self' data: https:;
              frame-src 'none';
              object-src 'none';
              base-uri 'self';
              form-action 'none';">
    
    <title>EcoGrow Control - Remote Panel</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK v9 (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* ... –≤–∞—à CSS –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... –≤–∞—à HTML –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBsZr7vWJDFt_S5i0Rvj6ejp6QT0JX9SPk",
            authDomain: "ecogrow-remote.firebaseapp.com",
            databaseURL: "https://ecogrow-remote-default-rtdb.firebaseio.com",
            projectId: "ecogrow-remote",
            storageBucket: "ecogrow-remote.firebasestorage.app",
            messagingSenderId: "121689275158",
            appId: "1:121689275158:web:f3b1829755c8b8a1fb2e37",
            measurementId: "G-PG5116NH38"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // –ü—É—Ç–∏ –≤ Firebase
        const ESP_DATA_PATH = 'esp8266/data';
        const ESP_COMMANDS_PATH = 'esp8266/commands';
        const ESP_STATUS_PATH = 'esp8266/status';

        let currentTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        
        let chart = null;
        let lastDataUpdate = 0;
        let isConnected = false;
        let connectionInterval;

        function updateThemeIcon() {
            document.querySelector('.theme-toggle').textContent = currentTheme === 'dark' ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
        }

        function initChart() {
            const ctx = document.getElementById('moist_chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å %',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        pointBackgroundColor: 'transparent',
                        pointBorderColor: 'transparent'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleFont: { size: 13 },
                            bodyFont: { size: 13 },
                            padding: 10,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(0, 0, 0, 0.08)' },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: { size: 11 },
                                padding: 5
                            }
                        },
                        x: { display: false }
                    },
                    interaction: { intersect: false },
                    animation: { duration: 800 }
                }
            });
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connection_dot');
            const text = document.getElementById('connection_text');
            
            if (connected) {
                dot.className = 'status-dot status-connected';
                text.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É';
                isConnected = true;
            } else {
                dot.className = 'status-dot status-disconnected';
                text.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                isConnected = false;
            }
        }

        function connectToFirebase() {
            // –°–ª—É—à–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç ESP8266
            database.ref(ESP_DATA_PATH).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    lastDataUpdate = Date.now();
                    updateConnectionStatus(true);
                    updateUI(data);
                }
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            database.ref(ESP_STATUS_PATH).on('value', (snapshot) => {
                const status = snapshot.val();
                if (status && status.connected) {
                    updateConnectionStatus(true);
                }
            });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            connectionInterval = setInterval(() => {
                if (Date.now() - lastDataUpdate > 10000) {
                    updateConnectionStatus(false);
                }
            }, 5000);
        }

        function updateUI(data) {
            document.getElementById('moist_status').textContent = data.moisture + '%';
            document.getElementById('current_moist').textContent = data.moisture + '%';
            document.getElementById('avg_moist').textContent = data.avg_moisture + '%';
            document.getElementById('min_moist').textContent = data.min_moisture + '%';
            
            document.getElementById('pump_switch').checked = data.pump;
            document.getElementById('pump_status').textContent = data.pump ? '–í–ö–õ' : '–í–´–ö–õ';
            document.getElementById('pump_status').className = 'status-badge ' + (data.pump ? 'status-on' : 'status-off');
            document.getElementById('pump_mode').textContent = '–†–µ–∂–∏–º: ' + (data.manual_pump ? '–†–£–ß–ù–û–ô' : '–ê–í–¢–û');
            
            document.getElementById('light_switch').checked = data.light;
            document.getElementById('light_status').textContent = data.light ? '–í–ö–õ' : '–í–´–ö–õ';
            document.getElementById('light_status').className = 'status-badge ' + (data.light ? 'status-on' : 'status-off');
            document.getElementById('light_mode').textContent = '–†–µ–∂–∏–º: ' + (data.manual_light ? '–†–£–ß–ù–û–ô' : '–ê–í–¢–û');
            
            document.getElementById('sleep_enabled').checked = data.sleep_enabled;
            const now = new Date();
            const sleepActive = data.sleep_enabled && timeInRange(now, data.sleep_start, data.sleep_end);
            document.getElementById('sleep_status').textContent = sleepActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
            document.getElementById('sleep_status').className = 'status-badge ' + (sleepActive ? 'status-on' : 'status-off');
            
            document.getElementById('moist_threshold').value = data.moisture_threshold;
            document.getElementById('thresh_val').textContent = data.moisture_threshold + '%';
            document.getElementById('watering_delay').value = data.watering_delay;
            document.getElementById('watering_duration').value = data.watering_duration;
            document.getElementById('manual_pump_time').value = data.manual_pump_time || 10;
            document.getElementById('manual_light_time').value = data.manual_light_time || 1;
            document.getElementById('lamp_start').value = data.lamp_start;
            document.getElementById('lamp_end').value = data.lamp_end;
            document.getElementById('lamp_enabled').checked = data.lamp_enabled;
            document.getElementById('sleep_start').value = data.sleep_start;
            document.getElementById('sleep_end').value = data.sleep_end;
            document.getElementById('sleep_enabled').checked = data.sleep_enabled;
            document.getElementById('time_manual').checked = data.time_manual || false;
            
            document.getElementById('total_waterings').textContent = data.total_waterings;
            document.getElementById('total_light_hours').textContent = data.total_light_hours;
            document.getElementById('energy_consumption').textContent = data.total_energy;
            
            const timeSinceWatering = data.time_since_watering || 0;
            const wateringDelayMs = data.watering_delay * 60000 || 1800000;
            const timeLeft = Math.max(0, Math.floor((wateringDelayMs - timeSinceWatering) / 60000));
            document.getElementById('timer_value').textContent = timeLeft;
            
            document.getElementById('current_time_display').textContent = '–¢–µ–∫—É—â–µ–µ: ' + (data.current_time || '--:--');
            document.getElementById('time_mode').textContent = (data.time_manual ? '–†—É—á–Ω–æ–µ' : '–ê–≤—Ç–æ');
            document.getElementById('time_mode').className = 'status-badge ' + (data.time_manual ? 'status-on' : '');
            
            updateErrors(data.errors || []);
            
            if (data.moisture_history && data.moisture_history.length > 0) {
                updateChart(data.moisture_history);
            }
        }

        function updateChart(data) {
            if (!chart) initChart();
            
            chart.data.datasets[0].data = data;
            const labels = [];
            for (let i = 0; i < data.length; i++) labels.push('');
            chart.data.labels = labels;
            
            chart.update('none');
        }

        function updateErrors(errors) {
            const container = document.getElementById('errors_container');
            const errorCount = document.getElementById('error_count');
            
            if (!errors || errors.length === 0) {
                container.innerHTML = '<div class="error-item"><div class="error-msg">‚úÖ –û—à–∏–±–æ–∫ –Ω–µ—Ç</div></div>';
                errorCount.textContent = '0';
                errorCount.className = 'status-badge';
                return;
            }
            
            errorCount.textContent = errors.length;
            errorCount.className = 'status-badge status-error';
            
            let html = '';
            errors.forEach(error => {
                html += `
                    <div class="error-item">
                        <div class="error-time">üïê ${error.time}</div>
                        <div class="error-msg">${error.msg}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function timeInRange(now, startStr, endStr) {
            const [startHour, startMin] = startStr.split(':').map(Number);
            const [endHour, endMin] = endStr.split(':').map(Number);
            const nowHour = now.getHours();
            const nowMin = now.getMinutes();
            
            const start = startHour * 60 + startMin;
            const end = endHour * 60 + endMin;
            const current = nowHour * 60 + nowMin;
            
            if (start <= end) {
                return current >= start && current < end;
            } else {
                return current >= start || current < end;
            }
        }

        function updateThreshold(value) {
            document.getElementById('thresh_val').textContent = value + '%';
        }

        async function sendCommand(command, data) {
            if (!isConnected) {
                showNotification('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º');
                return;
            }
            
            try {
                const timestamp = Date.now();
                const commandData = {
                    ...data,
                    timestamp: timestamp,
                    executed: false
                };
                
                await database.ref(`${ESP_COMMANDS_PATH}/${command}`).set(commandData);
                showNotification('‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
                
                // –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    database.ref(`${ESP_COMMANDS_PATH}/${command}`).remove();
                }, 10000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã');
            }
        }

        async function saveSettings() {
            const settings = {
                moisture_threshold: parseInt(document.getElementById('moist_threshold').value),
                watering_delay: parseInt(document.getElementById('watering_delay').value),
                watering_duration: parseInt(document.getElementById('watering_duration').value),
                manual_pump_time: parseInt(document.getElementById('manual_pump_time').value),
                manual_light_time: parseInt(document.getElementById('manual_light_time').value),
                lamp_start: document.getElementById('lamp_start').value,
                lamp_end: document.getElementById('lamp_end').value,
                lamp_enabled: document.getElementById('lamp_enabled').checked,
                sleep_start: document.getElementById('sleep_start').value,
                sleep_end: document.getElementById('sleep_end').value,
                sleep_enabled: document.getElementById('sleep_enabled').checked,
                time_manual: document.getElementById('time_manual').checked
            };
            
            await sendCommand('settings', settings);
        }

        async function togglePump() {
            const on = document.getElementById('pump_switch').checked;
            await sendCommand('pump', { state: on ? 'on' : 'off' });
        }

        async function setPumpAuto() {
            await sendCommand('pumpAuto', {});
        }

        async function toggleLight() {
            const on = document.getElementById('light_switch').checked;
            await sendCommand('light', { state: on ? 'on' : 'off' });
        }

        async function setLightAuto() {
            await sendCommand('lightAuto', {});
        }

        async function manualWatering() {
            await sendCommand('water', {});
        }

        async function clearErrors() {
            await sendCommand('clearErrors', {});
        }

        async function refreshErrors() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –¥–∞–Ω–Ω—ã–µ
            database.ref(ESP_DATA_PATH).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateUI(data);
                }
            });
        }

        async function toggleTimeMode() {
            const manual = document.getElementById('time_manual').checked;
            await sendCommand('timeMode', { manual: manual });
        }

        async function setCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            await sendCommand('setTime', { hours: hours, minutes: minutes });
        }

        async function setCustomTime() {
            const hours = parseInt(document.getElementById('time_hours').value);
            const minutes = parseInt(document.getElementById('time_minutes').value);
            
            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                showNotification('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è');
                return;
            }
            
            await sendCommand('setTime', { hours: hours, minutes: minutes });
        }

        function showNotification(message) {
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(120%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        window.onload = function() {
            initChart();
            connectToFirebase();
            updateThemeIcon();
            
            showNotification('üåê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...');
            
            document.querySelectorAll('#watering_delay, #watering_duration, #manual_pump_time, #manual_light_time, #lamp_start, #lamp_end, #sleep_start, #sleep_end')
                .forEach(el => el.addEventListener('change', saveSettings));
            document.querySelectorAll('#lamp_enabled, #sleep_enabled, #time_manual')
                .forEach(el => el.addEventListener('change', saveSettings));
        };
    </script>
</body>
</html>
