<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGrow Remote Control</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #2ecc71;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        header {
            background: #2ecc71;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #95a5a6;
        }
        
        .status-dot.online { background: #2ecc71; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #2c3e50;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2ecc71;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .moisture-value {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #3498db;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .btn-primary { background: #2ecc71; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-secondary { background: #3498db; color: white; }
        
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .error-log {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .error-item {
            padding: 5px;
            margin-bottom: 5px;
            border-left: 3px solid #e74c3c;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        select, input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #34495e;
            background: #2c3e50;
            color: white;
            margin: 5px 0;
            width: 100%;
        }
        
        .slider-container {
            margin: 20px 0;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #34495e;
            outline: none;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå± EcoGrow Control Panel</h1>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</span>
            </div>
            <select id="deviceSelect" style="margin-top: 10px;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ...</option>
            </select>
        </header>

        <div id="loading" style="text-align: center; padding: 50px;">
            <div style="font-size: 48px; margin-bottom: 20px;">üå±</div>
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
            <p>–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –≤–∞—à–µ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É</p>
        </div>

        <div id="dashboard" class="dashboard" style="display: none;">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ -->
            <div class="card">
                <div class="card-title"><i class="fas fa-tint"></i> –í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã</div>
                <div class="moisture-value" id="moistureValue">--%</div>
                <div class="slider-container">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>–ü–æ—Ä–æ–≥ –ø–æ–ª–∏–≤–∞:</span>
                        <span id="thresholdValue">50%</span>
                    </div>
                    <input type="range" min="10" max="90" value="50" id="thresholdSlider">
                </div>
                <button class="btn btn-secondary" onclick="saveThreshold()" style="width: 100%;">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä–æ–≥
                </button>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å–æ—Å–æ–º -->
            <div class="card">
                <div class="card-title"><i class="fas fa-faucet"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–º</div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="sendCommand('pump', 'on')" id="pumpOnBtn">
                        <i class="fas fa-play"></i> –í–∫–ª—é—á–∏—Ç—å
                    </button>
                    <button class="btn btn-danger" onclick="sendCommand('pump', 'off')" id="pumpOffBtn">
                        <i class="fas fa-stop"></i> –í—ã–∫–ª—é—á–∏—Ç—å
                    </button>
                    <button class="btn btn-secondary" onclick="sendCommand('pump', 'water')" style="grid-column: span 2;">
                        <i class="fas fa-tint"></i> –ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å
                    </button>
                </div>
                <div class="stat">
                    <span>–°—Ç–∞—Ç—É—Å:</span>
                    <span id="pumpStatus">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–µ—Ç–æ–º -->
            <div class="card">
                <div class="card-title"><i class="fas fa-lightbulb"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–æ–º</div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="sendCommand('light', 'on')" id="lightOnBtn">
                        <i class="fas fa-power-off"></i> –í–∫–ª—é—á–∏—Ç—å
                    </button>
                    <button class="btn btn-danger" onclick="sendCommand('light', 'off')" id="lightOffBtn">
                        <i class="fas fa-power-off"></i> –í—ã–∫–ª—é—á–∏—Ç—å
                    </button>
                </div>
                <div class="stat">
                    <span>–°—Ç–∞—Ç—É—Å:</span>
                    <span id="lightStatus">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
            <div class="card">
                <div class="card-title"><i class="fas fa-cogs"></i> –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</div>
                <div class="stat">
                    <span>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</span>
                    <span id="deviceName">--</span>
                </div>
                <div class="stat">
                    <span>–í–µ—Ä—Å–∏—è –ü–û:</span>
                    <span id="firmwareVersion">--</span>
                </div>
                <div class="stat">
                    <span>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</span>
                    <span id="uptime">--</span>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" onclick="clearErrors()" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –æ—à–∏–±–∫–∏
                    </button>
                    <button class="btn btn-danger" onclick="rebootDevice()" style="width: 100%;">
                        <i class="fas fa-redo"></i> –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>EcoGrow Smart Plant System v4.5</p>
            <p>¬© 2026 EcoGrow Project</p>
            <p style="margin-top: 10px;">
                <a href="javascript:void(0)" onclick="testConnection()" style="color: #3498db; text-decoration: none;">
                    <i class="fas fa-wifi"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                </a>
            </p>
        </footer>
    </div>

    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyBsZr7vWJDFt_S5i0Rvj6ejp6QT0JX9SPk",
            authDomain: "ecogrow-remote.firebaseapp.com",
            databaseURL: "https://ecogrow-remote-default-rtdb.firebaseio.com",
            projectId: "ecogrow-remote",
            storageBucket: "ecogrow-remote.appspot.com",
            messagingSenderId: "121689275158",
            appId: "1:121689275158:web:f3b1829755c8b8a1fb2e37"
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentDeviceId = null;
        let firebaseApp = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            initializeFirebase();
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        function initializeFirebase() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
                firebaseApp = firebase.initializeApp(firebaseConfig);
                console.log('‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
                // –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                firebase.auth().signInAnonymously()
                    .then(() => {
                        console.log('‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
                        updateStatus(true);
                        loadDevices();
                    })
                    .catch(error => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
                        updateStatus(false);
                        loadDevices(); // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    });
                    
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase', 'error');
                updateStatus(false);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.classList.add('online');
                statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase';
                statusText.style.color = '#2ecc71';
            } else {
                statusDot.classList.remove('online');
                statusText.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç Firebase';
                statusText.style.color = '#e74c3c';
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function loadDevices() {
            console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤...');
            
            const devicesRef = firebase.database().ref('devices');
            
            devicesRef.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    const deviceSelect = document.getElementById('deviceSelect');
                    
                    deviceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ...</option>';
                    
                    if (data) {
                        Object.keys(data).forEach(deviceId => {
                            const device = data[deviceId];
                            const deviceName = device.info?.device_name || device.info?.name || `–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ${deviceId}`;
                            const isOnline = device.state?.online || false;
                            
                            const option = document.createElement('option');
                            option.value = deviceId;
                            option.textContent = `${deviceName} ${isOnline ? 'üü¢' : 'üî¥'}`;
                            deviceSelect.appendChild(option);
                            
                            console.log(`–ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${deviceName} (${deviceId})`);
                        });
                        
                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                        const savedDeviceId = localStorage.getItem('ecogrow-device-id');
                        if (savedDeviceId && data[savedDeviceId]) {
                            deviceSelect.value = savedDeviceId;
                            selectDevice(savedDeviceId);
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                        deviceSelect.addEventListener('change', function() {
                            selectDevice(this.value);
                        });
                        
                    } else {
                        console.log('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ Firebase');
                        showNotification('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.', 'warning');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:', error);
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤', 'error');
                });
        }
        
        // –í—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function selectDevice(deviceId) {
            console.log(`üéØ –í—ã–±—Ä–∞–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${deviceId}`);
            
            if (!deviceId) {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
                return;
            }
            
            currentDeviceId = deviceId;
            localStorage.setItem('ecogrow-device-id', deviceId);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'grid';
            
            // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            listenToDeviceData();
        }
        
        // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function listenToDeviceData() {
            if (!currentDeviceId) return;
            
            console.log(`üëÇ –°–ª—É—à–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${currentDeviceId}`);
            
            // –°–ª—É—à–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            const stateRef = firebase.database().ref(`devices/${currentDeviceId}/state`);
            
            stateRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateDeviceUI(data);
                }
            });
            
            // –°–ª—É—à–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
            const infoRef = firebase.database().ref(`devices/${currentDeviceId}/info`);
            infoRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateDeviceInfo(data);
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function updateDeviceUI(data) {
            // –í–ª–∞–∂–Ω–æ—Å—Ç—å
            if (data.moisture !== undefined) {
                document.getElementById('moistureValue').textContent = data.moisture + '%';
                
                // –¶–≤–µ—Ç –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
                const moistureValue = document.getElementById('moistureValue');
                if (data.moisture < 30) {
                    moistureValue.style.color = '#e74c3c';
                } else if (data.moisture < 60) {
                    moistureValue.style.color = '#f39c12';
                } else {
                    moistureValue.style.color = '#3498db';
                }
            }
            
            // –ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
            if (data.moisture_threshold !== undefined) {
                document.getElementById('thresholdValue').textContent = data.moisture_threshold + '%';
                document.getElementById('thresholdSlider').value = data.moisture_threshold;
            }
            
            // –°—Ç–∞—Ç—É—Å –Ω–∞—Å–æ—Å–∞
            if (data.pump_on !== undefined) {
                document.getElementById('pumpStatus').textContent = data.pump_on ? '–í–ö–õ–Æ–ß–ï–ù' : '–í–´–ö–õ–Æ–ß–ï–ù';
                document.getElementById('pumpOnBtn').disabled = data.pump_on;
                document.getElementById('pumpOffBtn').disabled = !data.pump_on;
            }
            
            // –°—Ç–∞—Ç—É—Å —Å–≤–µ—Ç–∞
            if (data.light_on !== undefined) {
                document.getElementById('lightStatus').textContent = data.light_on ? '–í–ö–õ–Æ–ß–ï–ù' : '–í–´–ö–õ–Æ–ß–ï–ù';
                document.getElementById('lightOnBtn').disabled = data.light_on;
                document.getElementById('lightOffBtn').disabled = !data.light_on;
            }
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
            if (data.firmware_version !== undefined) {
                document.getElementById('firmwareVersion').textContent = data.firmware_version;
            }
            
            if (data.uptime !== undefined) {
                const hours = Math.floor(data.uptime / 3600);
                const minutes = Math.floor((data.uptime % 3600) / 60);
                document.getElementById('uptime').textContent = `${hours}—á ${minutes}–º`;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        function updateDeviceInfo(info) {
            if (info.device_name) {
                document.getElementById('deviceName').textContent = info.device_name;
            }
        }
        
        // –û–¢–ü–†–ê–í–ö–ê –ö–û–ú–ê–ù–î - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        function sendCommand(type, action) {
            console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã: ${type}=${action}`);
            
            if (!currentDeviceId) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ!', 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –∫–æ–º–∞–Ω–¥—ã
            const command = {};
            command[type] = action;
            command.timestamp = Date.now();
            
            console.log('–ö–æ–º–∞–Ω–¥–∞:', command);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤ Firebase
            const commandsRef = firebase.database().ref(`devices/${currentDeviceId}/commands`);
            
            commandsRef.update(command)
                .then(() => {
                    console.log('‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ Firebase');
                    showNotification(`–ö–æ–º–∞–Ω–¥–∞ "${action}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞`);
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã:', error);
                    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã', 'error');
                });
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
        function saveThreshold() {
            const value = document.getElementById('thresholdSlider').value;
            
            if (!currentDeviceId) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ!', 'error');
                return;
            }
            
            console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞: ${value}%`);
            
            const commandsRef = firebase.database().ref(`devices/${currentDeviceId}/commands`);
            
            commandsRef.update({
                moisture_threshold: parseInt(value),
                timestamp: Date.now()
            })
            .then(() => {
                showNotification('–ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            });
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
        function clearErrors() {
            if (!currentDeviceId) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ!', 'error');
                return;
            }
            
            const commandsRef = firebase.database().ref(`devices/${currentDeviceId}/commands`);
            
            commandsRef.update({
                clear_errors: true,
                timestamp: Date.now()
            })
            .then(() => {
                showNotification('–û—à–∏–±–∫–∏ –æ—á–∏—â–µ–Ω—ã');
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –æ—à–∏–±–æ–∫:', error);
            });
        }
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function rebootDevice() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?')) return;
            
            if (!currentDeviceId) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ!', 'error');
                return;
            }
            
            const commandsRef = firebase.database().ref(`devices/${currentDeviceId}/commands`);
            
            commandsRef.update({
                reboot: true,
                timestamp: Date.now()
            })
            .then(() => {
                showNotification('–ö–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:', error);
            });
        }
        
        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function testConnection() {
            console.log('üß™ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
            
            if (!firebaseApp) {
                showNotification('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }
            
            const testRef = firebase.database().ref('test_connection');
            
            testRef.set({
                test: true,
                timestamp: Date.now()
            })
            .then(() => {
                showNotification('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                testRef.remove(); // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            })
            .catch(error => {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase', 'error');
            });
        }
        
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'error' ? '#e74c3c' : '#2ecc71';
            
            let icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-triangle';
            
            notification.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è HTML
        window.sendCommand = sendCommand;
        window.saveThreshold = saveThreshold;
        window.clearErrors = clearErrors;
        window.rebootDevice = rebootDevice;
        window.testConnection = testConnection;
    </script>
</body>
</html>
