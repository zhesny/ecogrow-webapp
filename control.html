<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º - EcoGrow</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .device-info-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border-left: 5px solid #27ae60;
        }
        
        .info-card.error {
            border-left-color: #e74c3c;
        }
        
        .info-card.warning {
            border-left-color: #f39c12;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .controls-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .control-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .control-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        
        .status-on {
            background: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }
        
        .status-off {
            background: #e74c3c;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
        }
        
        .slider-container {
            margin-top: 15px;
        }
        
        .slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #e1e8ed;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #27ae60;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .slider-value {
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .settings-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .setting-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .setting-input {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .setting-input:focus {
            border-color: #27ae60;
            outline: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            border-left: 5px solid #27ae60;
            max-width: 400px;
            font-weight: 500;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            border-left-color: #e74c3c;
        }
        
        .notification.warning {
            border-left-color: #f39c12;
        }
        
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–ê–ü–ö–ê -->
        <div class="header">
            <h1 id="deviceTitle">üå± –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...</h1>
            <button class="back-btn" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º</button>
        </div>
        
        <!-- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –£–°–¢–†–û–ô–°–¢–í–ï -->
        <div class="device-info-panel">
            <h2>üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h2>
            <div id="deviceInfo" class="info-grid">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                <div class="info-card">
                    <div class="info-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã</div>
                    <div class="info-value">-- %</div>
                </div>
                <div class="info-card">
                    <div class="info-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞—Å–æ—Å–∞</div>
                    <div class="info-value">--</div>
                </div>
                <div class="info-card">
                    <div class="info-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–µ—Ç–∞</div>
                    <div class="info-value">--</div>
                </div>
                <div class="info-card">
                    <div class="info-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                    <div class="info-value">--</div>
                </div>
            </div>
        </div>
        
        <!-- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
        <div class="controls-panel">
            <h2>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <div class="controls-grid">
                <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–°–û–°–û–ú -->
                <div class="control-card">
                    <div class="control-title">
                        <span class="status-indicator" id="pumpStatus"></span>
                        –í–æ–¥—è–Ω–æ–π –Ω–∞—Å–æ—Å
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="sendCommand('pump', 1)">
                            üíß –í–∫–ª—é—á–∏—Ç—å
                        </button>
                        <button class="btn btn-danger" onclick="sendCommand('pump', 0)">
                            ‚õî –í—ã–∫–ª—é—á–∏—Ç—å
                        </button>
                    </div>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="sendCommand('pumpAuto', 1)">
                            üîÑ –ê–≤—Ç–æ—Ä–µ–∂–∏–º
                        </button>
                    </div>
                </div>
                
                <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–í–ï–¢–û–ú -->
                <div class="control-card">
                    <div class="control-title">
                        <span class="status-indicator" id="lightStatus"></span>
                        –û—Å–≤–µ—â–µ–Ω–∏–µ
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="sendCommand('light', 1)">
                            üí° –í–∫–ª—é—á–∏—Ç—å
                        </button>
                        <button class="btn btn-danger" onclick="sendCommand('light', 0)">
                            üåô –í—ã–∫–ª—é—á–∏—Ç—å
                        </button>
                    </div>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="sendCommand('lightAuto', 1)">
                            üîÑ –ê–≤—Ç–æ—Ä–µ–∂–∏–º
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div class="settings-panel">
            <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <label class="setting-label">–ü–æ—Ä–æ–≥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ (%)</label>
                    <input type="number" id="thresholdInput" class="setting-input" min="10" max="90" value="50">
                    <button class="btn btn-primary" onclick="setThreshold()" style="margin-top: 10px;">
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–∞ (—Å–µ–∫)</label>
                    <input type="number" id="pumpTimeInput" class="setting-input" min="1" max="600" value="10">
                    <button class="btn btn-primary" onclick="setPumpTime()" style="margin-top: 10px;">
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è (–ß–ß:–ú–ú)</label>
                    <input type="time" id="timeInput" class="setting-input" value="12:00">
                    <button class="btn btn-primary" onclick="setDeviceTime()" style="margin-top: 10px;">
                        –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
        <div id="notification" class="notification"></div>
    </div>

    <script>
        // ============================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBJSFgQqIrsXj88Xq9h_vwzWjsbZq3z7r8",
            authDomain: "ecogrow-remote.firebaseapp.com",
            databaseURL: "https://ecogrow-remote-default-rtdb.firebaseio.com",
            projectId: "ecogrow-remote",
            storageBucket: "ecogrow-remote.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let database = null;
        let currentDeviceId = null;
        let deviceData = null;

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
            
            // –ü–æ–ª—É—á–∞–µ–º ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            currentDeviceId = urlParams.get('device');
            
            if (!currentDeviceId) {
                showNotification('‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ', true);
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            try {
                const app = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log("‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                document.getElementById('deviceTitle').textContent = `üå± –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${currentDeviceId}`;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                loadDeviceData();
                
                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
                setInterval(loadDeviceData, 3000);
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                showNotification(`‚ùå –û—à–∏–±–∫–∞ Firebase: ${error.message}`, true);
            }
        });

        // ============================================
        // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –£–°–¢–†–û–ô–°–¢–í–ê
        // ============================================
        function loadDeviceData() {
            if (!database || !currentDeviceId) return;
            
            database.ref('devices/' + currentDeviceId).on('value', (snapshot) => {
                deviceData = snapshot.val();
                
                if (!deviceData) {
                    showNotification('‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ', true);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                updateDeviceInfo(deviceData);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                updateStatusIndicators(deviceData);
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:", error);
                showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, true);
            });
        }

        function updateDeviceInfo(data) {
            const infoGrid = document.getElementById('deviceInfo');
            
            const moisture = data.data?.moisture || '--';
            const pumpStatus = data.data?.pump ? '–í–ö–õ' : '–í–´–ö–õ';
            const lightStatus = data.data?.light ? '–í–ö–õ' : '–í–´–ö–õ';
            const lastUpdate = data.data?.timestamp ? 
                new Date(data.data.timestamp * 1000).toLocaleTimeString() : '--';
            
            infoGrid.innerHTML = `
                <div class="info-card ${moisture < 30 ? 'warning' : ''}">
                    <div class="info-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã</div>
                    <div class="info-value">${moisture}%</div>
                </div>
                <div class="info-card ${data.data?.pump ? 'warning' : ''}">
                    <div class="info-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞—Å–æ—Å–∞</div>
                    <div class="info-value">${pumpStatus}</div>
                </div>
                <div class="info-card ${data.data?.light ? 'warning' : ''}">
                    <div class="info-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–µ—Ç–∞</div>
                    <div class="info-value">${lightStatus}</div>
                </div>
                <div class="info-card">
                    <div class="info-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                    <div class="info-value">${lastUpdate}</div>
                </div>
            `;
        }

        function updateStatusIndicators(data) {
            const pumpStatus = document.getElementById('pumpStatus');
            const lightStatus = document.getElementById('lightStatus');
            
            pumpStatus.className = 'status-indicator ' + (data.data?.pump ? 'status-on' : 'status-off');
            lightStatus.className = 'status-indicator ' + (data.data?.light ? 'status-on' : 'status-off');
        }

        // ============================================
        // –û–¢–ü–†–ê–í–ö–ê –ö–û–ú–ê–ù–î
        // ============================================
        function sendCommand(command, value) {
            if (!database || !currentDeviceId) {
                showNotification('‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö', true);
                return;
            }
            
            console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã: ${command}=${value} –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ${currentDeviceId}`);
            
            let commandData = {
                command: command,
                value: value,
                timestamp: Date.now(),
                source: 'web_control'
            };
            
            // –î–ª—è –∫–æ–º–∞–Ω–¥—ã setTime –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è
            if (command === 'setTime') {
                const timeInput = document.getElementById('timeInput').value;
                const [hours, minutes] = timeInput.split(':');
                commandData.hour = parseInt(hours);
                commandData.minute = parseInt(minutes);
            }
            
            database.ref('devices/' + currentDeviceId + '/commands/latest').set(commandData)
            .then(() => {
                showNotification(`‚úÖ –ö–æ–º–∞–Ω–¥–∞ "${command}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞`);
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã:", error);
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, true);
            });
        }

        function setThreshold() {
            const threshold = document.getElementById('thresholdInput').value;
            if (threshold >= 10 && threshold <= 90) {
                sendCommand('threshold', parseInt(threshold));
            } else {
                showNotification('‚ùå –ü–æ—Ä–æ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 10% –¥–æ 90%', true);
            }
        }

        function setPumpTime() {
            const pumpTime = document.getElementById('pumpTimeInput').value;
            if (pumpTime >= 1 && pumpTime <= 600) {
                sendCommand('pumpTime', parseInt(pumpTime));
            } else {
                showNotification('‚ùå –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 600 —Å–µ–∫—É–Ω–¥', true);
            }
        }

        function setDeviceTime() {
            sendCommand('setTime', 1);
        }

        // ============================================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ============================================
        function goBack() {
            window.location.href = 'index.html';
        }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                goBack();
            }
        });
    </script>
</body>
</html>
